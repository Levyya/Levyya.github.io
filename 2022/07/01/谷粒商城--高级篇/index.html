<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>谷粒商城--高级篇 | Levy's blog</title><meta name="keywords" content="项目"><meta name="author" content="Levy"><meta name="copyright" content="Levy"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="学习目标P103-P339  mq  启动服务nacos 1cd F:\work\project\Enviroment\download\nacos-server-2.1.0\nacos\bin  前端vue 12cd F:\work\java\Code\gulimall-vue\renren-fast-vuenpm run dev  虚拟机–virtual box nginx, redis, m">
<meta property="og:type" content="article">
<meta property="og:title" content="谷粒商城--高级篇">
<meta property="og:url" content="https://levyya.github.io/2022/07/01/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E--%E9%AB%98%E7%BA%A7%E7%AF%87/index.html">
<meta property="og:site_name" content="Levy&#39;s blog">
<meta property="og:description" content="学习目标P103-P339  mq  启动服务nacos 1cd F:\work\project\Enviroment\download\nacos-server-2.1.0\nacos\bin  前端vue 12cd F:\work\java\Code\gulimall-vue\renren-fast-vuenpm run dev  虚拟机–virtual box nginx, redis, m">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://levy-blog.oss-cn-hangzhou.aliyuncs.com/pics/TomAndJerry.jpg">
<meta property="article:published_time" content="2022-06-30T16:00:00.000Z">
<meta property="article:modified_time" content="2023-01-10T12:35:16.000Z">
<meta property="article:author" content="Levy">
<meta property="article:tag" content="项目">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://levy-blog.oss-cn-hangzhou.aliyuncs.com/pics/TomAndJerry.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://levyya.github.io/2022/07/01/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E--%E9%AB%98%E7%BA%A7%E7%AF%87/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '谷粒商城--高级篇',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-01-10 20:35:16'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="/css/background_color.css"><meta name="generator" content="Hexo 6.0.0"><link rel="alternate" href="/atom.xml" title="Levy's blog" type="application/atom+xml">
</head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://levy-blog.oss-cn-hangzhou.aliyuncs.com/pics/%E9%98%BF%E5%B0%BC%E4%BA%9A.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data is-center"><div class="data-item"><a href="/archives/"><div class="headline">文章</div><div class="length-num">70</div></a></div><div class="data-item"><a href="/tags/"><div class="headline">标签</div><div class="length-num">38</div></a></div><div class="data-item"><a href="/categories/"><div class="headline">分类</div><div class="length-num">18</div></a></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://levy-blog.oss-cn-hangzhou.aliyuncs.com/pics/TomAndJerry.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Levy's blog</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">谷粒商城--高级篇</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-06-30T16:00:00.000Z" title="发表于 2022-07-01 00:00:00">2022-07-01</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-01-10T12:35:16.000Z" title="更新于 2023-01-10 20:35:16">2023-01-10</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="谷粒商城--高级篇"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h2 id="学习目标"><a href="#学习目标" class="headerlink" title="学习目标"></a>学习目标</h2><p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1np4y1C7Yf?p=170&vd_source=53b8cc6488ce514ed3a9458e8e4f939a">P103-P339</a></p>
<ul>
<li>mq</li>
</ul>
<h3 id="启动服务"><a href="#启动服务" class="headerlink" title="启动服务"></a>启动服务</h3><p>nacos</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> F:\work\project\Enviroment\download\nacos-server-2.1.0\nacos\bin</span><br></pre></td></tr></table></figure>

<p>前端vue</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> F:\work\java\Code\gulimall-vue\renren-fast-vue</span><br><span class="line">npm run dev</span><br></pre></td></tr></table></figure>

<p>虚拟机–virtual box</p>
<p>nginx, redis, mysql, es, kibana</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker ps</span><br></pre></td></tr></table></figure>

<h3 id="压力测试"><a href="#压力测试" class="headerlink" title="压力测试"></a>压力测试</h3><p>jmeter</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd F:\work\project\Enviroment\download\apache-jmeter-5.5\bin</span><br></pre></td></tr></table></figure>

<p>.&#x2F;jmeter.bat</p>
<h3 id="P103-Elasticsearch"><a href="#P103-Elasticsearch" class="headerlink" title="P103 Elasticsearch"></a>P103 Elasticsearch</h3><h5 id="ES安装"><a href="#ES安装" class="headerlink" title="ES安装"></a>ES安装</h5><ol>
<li><p>下载ealastic search和kibana</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker pull elasticsearch:7.6.2</span><br><span class="line">docker pull kibana:7.6.2</span><br></pre></td></tr></table></figure>
</li>
<li><p>配置</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /mydata/elasticsearch/config  创建目录</span><br><span class="line">mkdir -p /mydata/elasticsearch/data</span><br><span class="line">echo &quot;http.host: 0.0.0.0&quot; &gt;/mydata/elasticsearch/config/elasticsearch.yml</span><br><span class="line"></span><br><span class="line">//将mydata/elasticsearch/文件夹中文件都可读可写</span><br><span class="line">chmod -R 777 /mydata/elasticsearch/</span><br></pre></td></tr></table></figure>


</li>
<li><p>启动Elastic search 和 kibana</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">docker run --name elasticsearch -p 9200:9200 -p 9300:9300 \</span><br><span class="line">-e  &quot;discovery.type=single-node&quot; \</span><br><span class="line">-e ES_JAVA_OPTS=&quot;-Xms64m -Xmx512m&quot; \</span><br><span class="line">-v /mydata/elasticsearch/config/elasticsearch.yml:/usr/share/elasticsearch/config/elasticsearch.yml \</span><br><span class="line">-v /mydata/elasticsearch/data:/usr/share/elasticsearch/data \</span><br><span class="line">-v  /mydata/elasticsearch/plugins:/usr/share/elasticsearch/plugins \</span><br><span class="line">-d elasticsearch:7.6.2 </span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run --name kibana -e ELASTICSEARCH_HOSTS=http://192.168.56.10:9200 -p 5601:5601 -d kibana:7.6.2</span><br></pre></td></tr></table></figure>
</li>
<li><p>设置开机启动elasticsearch</p>
</li>
</ol>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker update elasticsearch --restart=always</span><br><span class="line">docker update kibana  --restart=always</span><br></pre></td></tr></table></figure>

<ol start="5">
<li><p>测试</p>
<p><a target="_blank" rel="noopener" href="http://192.168.56.10:9200/">http://192.168.56.10:9200/</a> </p>
<p><a target="_blank" rel="noopener" href="http://192.168.56.10:5601/app/kibana">http://192.168.56.10:5601/app/kibana</a></p>
</li>
</ol>
<h4 id="初步检索"><a href="#初步检索" class="headerlink" title="初步检索"></a>初步检索</h4><p>example</p>
<p><a target="_blank" rel="noopener" href="http://192.168.56.10:9200/_cat/nodes">http://192.168.56.10:9200/_cat/nodes</a></p>
<ol>
<li>GET &#x2F;_cat&#x2F;nodes    查看所有节点</li>
<li>GET &#x2F;_cat&#x2F;health    查看es健康状况</li>
<li>GET &#x2F;_cat&#x2F;master    查看主节点信息</li>
<li>GET&#x2F;_cat&#x2F;indices：查看所有索引</li>
</ol>
<h5 id="索引文档"><a href="#索引文档" class="headerlink" title="索引文档"></a>索引文档</h5><ol>
<li><p>PUT customer&#x2F;external&#x2F;1</p>
<p>request body</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line"> &quot;name&quot;:&quot;John Doe&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>POST customer&#x2F;external&#x2F;</p>
</li>
</ol>
<p>区别：</p>
<p>如果不指定id，会自动生成id。指定id就会修改这个数据，并新增版本号；<br>PUT可以新增也可以修改。PUT必须指定id；由于PUT需要指定id，我们一般用来做修改操作，不指定id会报错。</p>
<h5 id="查看文档"><a href="#查看文档" class="headerlink" title="查看文档"></a>查看文档</h5><p>GET &#x2F;customer&#x2F;external&#x2F;1</p>
<p><a target="_blank" rel="noopener" href="http://192.168.56.10:9200/customer/external/1">http://192.168.56.10:9200/customer/external/1</a></p>
<p>乐观锁实现</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?if_seq_no=3&amp;if_primary_term=1</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="http://192.168.56.10:9200/customer/external/1?if_seq_no=3&amp;if_primary_term=1">http://192.168.56.10:9200/customer/external/1?if_seq_no=3&amp;if_primary_term=1</a></p>
<h5 id="更新文档"><a href="#更新文档" class="headerlink" title="更新文档"></a>更新文档</h5><p>（1）POST更新文档，带有_update</p>
<p>（2）POST更新文档，不带_update</p>
<p><a target="_blank" rel="noopener" href="http://192.168.56.10:9200/customer/external/1/_update">http://192.168.56.10:9200/customer/external/1/_update</a></p>
<p>不同：POST更新方式，会对比原来的数据，和原来的相同，则不执行任何操作（version和_seq_no）都不变。</p>
<p>使用场景：</p>
<p>对于大并发更新，不带update；</p>
<p>对于大并发查询偶尔更新，带update；</p>
<h5 id="删除文档或索引"><a href="#删除文档或索引" class="headerlink" title="删除文档或索引"></a>删除文档或索引</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">DELETE customer/external/1</span><br><span class="line">DELETE customer</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="http://192.168.56.10:9200/customer/external/1">http://192.168.56.10:9200/customer/external/1</a></p>
<h5 id="批量操作–bulk"><a href="#批量操作–bulk" class="headerlink" title="批量操作–bulk"></a>批量操作–bulk</h5><p>使用kibana的Dev Tools</p>
<p>example 1:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">POST /customer/external/_bulk</span><br><span class="line">&#123;&quot;index&quot;:&#123;&quot;_id&quot;:&quot;1&quot;&#125;&#125;</span><br><span class="line">&#123;&quot;name&quot;:&quot;John Doe&quot;&#125;</span><br><span class="line">&#123;&quot;index&quot;:&#123;&quot;_id&quot;:&quot;2&quot;&#125;&#125;</span><br><span class="line">&#123;&quot;name&quot;:&quot;John Doe&quot;&#125;</span><br></pre></td></tr></table></figure>

<p>example 2:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">POST /_bulk</span><br><span class="line">&#123;&quot;delete&quot;:&#123;&quot;_index&quot;:&quot;website&quot;,&quot;_type&quot;:&quot;blog&quot;,&quot;_id&quot;:&quot;123&quot;&#125;&#125;</span><br><span class="line">&#123;&quot;create&quot;:&#123;&quot;_index&quot;:&quot;website&quot;,&quot;_type&quot;:&quot;blog&quot;,&quot;_id&quot;:&quot;123&quot;&#125;&#125;</span><br><span class="line">&#123;&quot;title&quot;:&quot;my first blog post&quot;&#125;</span><br><span class="line">&#123;&quot;index&quot;:&#123;&quot;_index&quot;:&quot;website&quot;,&quot;_type&quot;:&quot;blog&quot;&#125;&#125;</span><br><span class="line">&#123;&quot;title&quot;:&quot;my second blog post&quot;&#125;</span><br><span class="line">&#123;&quot;update&quot;:&#123;&quot;_index&quot;:&quot;website&quot;,&quot;_type&quot;:&quot;blog&quot;,&quot;_id&quot;:&quot;123&quot;&#125;&#125;</span><br><span class="line">&#123;&quot;doc&quot;:&#123;&quot;title&quot;:&quot;my updated blog post&quot;&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>example 3:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">POST /bank/account/_bulk</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://github.com/elastic/elasticsearch/blob/7.4/docs/src/test/resources/accounts.json">https://github.com/elastic/elasticsearch/blob/7.4/docs/src/test/resources/accounts.json</a></p>
<h5 id="Search-API"><a href="#Search-API" class="headerlink" title="Search API"></a>Search API</h5><p>两种检索方式</p>
<ul>
<li>通过REST request uri 发送搜索参数 （uri +检索参数）；</li>
<li>通过REST request body 来发送它们（uri+请求体）；</li>
</ul>
<p>（1）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GET bank/_search?q=*&amp;sort=account_number:asc</span><br><span class="line">//q=* 查询所有，sort=account_number:asc 按照account_number进行asc升序排列sort</span><br></pre></td></tr></table></figure>

<p>（2）</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">GET /_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> </span><br><span class="line">    <span class="attr">&quot;bool&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> </span><br><span class="line">      <span class="attr">&quot;must&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span> <span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span>   <span class="string">&quot;Search&quot;</span>        <span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span> <span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;content&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Elasticsearch&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;filter&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span> </span><br><span class="line">        <span class="punctuation">&#123;</span> <span class="attr">&quot;term&quot;</span><span class="punctuation">:</span>  <span class="punctuation">&#123;</span> <span class="attr">&quot;status&quot;</span><span class="punctuation">:</span> <span class="string">&quot;published&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span> <span class="attr">&quot;range&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;publish_date&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;gte&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2015-01-01&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h5 id="Query-DSL"><a href="#Query-DSL" class="headerlink" title="Query DSL"></a>Query DSL</h5><p><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl.html">https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl.html</a></p>
<ul>
<li>match</li>
<li>match_phrase</li>
<li>multi_match</li>
<li>bool query</li>
<li>must &#x2F; must_not</li>
<li>should</li>
<li>filter (不会计算相关性得分)</li>
<li>term (全文检索字段用match，其他<strong>非text字段</strong>匹配用term)</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations.html">Aggregation</a></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">GET bank/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;address&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Mill&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;aggs&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;ageAgg&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;terms&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;field&quot;</span><span class="punctuation">:</span> <span class="string">&quot;age&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">10</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;ageAvg&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;avg&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;field&quot;</span><span class="punctuation">:</span> <span class="string">&quot;age&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;balanceAvg&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;avg&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;field&quot;</span><span class="punctuation">:</span> <span class="string">&quot;balance&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="comment">//ageAgg:聚合名字  terms：聚合类型  &quot;field&quot;: &quot;age&quot;:按照age字段聚合  size:10：取出前十种age</span></span><br><span class="line"><span class="comment">//avg：平均值聚合类型</span></span><br><span class="line"><span class="comment">//不显示这些人的详情，只看聚合结果</span></span><br></pre></td></tr></table></figure>

<p>example: 查出所有年龄分布，并且这些年龄段中M的平均薪资和F的平均薪资以及这个年龄段的总体平均薪资</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">GET bank/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;match_all&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;aggs&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;ageAgg&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;terms&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;field&quot;</span><span class="punctuation">:</span> <span class="string">&quot;age&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">100</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;aggs&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;genderAgg&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;terms&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;field&quot;</span><span class="punctuation">:</span> <span class="string">&quot;gender.keyword&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;aggs&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;balanceAvg&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;avg&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;field&quot;</span><span class="punctuation">:</span> <span class="string">&quot;balance&quot;</span></span><br><span class="line">              <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;ageBalanceAvg&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;avg&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;field&quot;</span><span class="punctuation">:</span> <span class="string">&quot;balance&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="comment">//&quot;field&quot;: &quot;gender.keyword&quot; gender是txt没法聚合 必须加.keyword精确替代</span></span><br></pre></td></tr></table></figure>

<h3 id="P119-129"><a href="#P119-129" class="headerlink" title="P119-129"></a>P119-129</h3><h5 id="Mapping"><a href="#Mapping" class="headerlink" title="Mapping"></a>Mapping</h5><h5 id="分词"><a href="#分词" class="headerlink" title="分词"></a>分词</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">GET /_analyze</span><br><span class="line">&#123;</span><br><span class="line">  &quot;analyzer&quot; : &quot;standard&quot;,</span><br><span class="line">  &quot;text&quot; : [&quot;this is a test&quot;, &quot;the second text&quot;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>下载ik分词器（releases对应es版本）</p>
<p><a target="_blank" rel="noopener" href="https://github.com/medcl/elasticsearch-analysis-ik/releases?page=6">https://github.com/medcl/elasticsearch-analysis-ik/releases?page=6</a></p>
<p>服务器配置ssh远程访问</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/ssh/sshd_config PubkeyAuthentication <span class="built_in">yes</span></span><br><span class="line">PasswordAuthentication <span class="built_in">yes</span>     //启用验证</span><br><span class="line">PubkeyAuthentication <span class="built_in">yes</span>      //  启用密钥对验证</span><br><span class="line">service sshd reload</span><br></pre></td></tr></table></figure>

<p>.&#x2F;bin</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">elasticsearch-plugins list</span><br></pre></td></tr></table></figure>

<p>docker restart elasticsearch</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">POST _analyze</span><br><span class="line">&#123;</span><br><span class="line">  &quot;analyzer&quot;: &quot;ik_smart&quot;,</span><br><span class="line">  &quot;text&quot;: [&quot;谷粒电商项目&quot;]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST _analyze</span><br><span class="line">&#123;</span><br><span class="line">  &quot;analyzer&quot;: &quot;ik_max_word&quot;,</span><br><span class="line">  &quot;text&quot;: [&quot;我是中国人&quot;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="P123-linux-网络配置-amp-yum-修改源"><a href="#P123-linux-网络配置-amp-yum-修改源" class="headerlink" title="P123 linux 网络配置 &amp; yum 修改源"></a>P123 linux 网络配置 &amp; yum 修改源</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y wget unzip</span><br></pre></td></tr></table></figure>

<h3 id="P124-安装nginx-amp-自定义词库"><a href="#P124-安装nginx-amp-自定义词库" class="headerlink" title="P124 安装nginx &amp; 自定义词库"></a>P124 安装nginx &amp; 自定义词库</h3><p>创建一个nginx</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -p 8081:80 --name nginx -d nginx:1.10   </span><br></pre></td></tr></table></figure>

<p>复制配置</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p /mydata/nginx/html</span><br><span class="line"><span class="built_in">mkdir</span> -p /mydata/nginx/logs</span><br><span class="line"><span class="built_in">mkdir</span> -p /mydata/nginx/conf</span><br><span class="line">docker container <span class="built_in">cp</span> nginx:/etc/nginx .  <span class="comment">#拷贝到当前文件夹</span></span><br><span class="line"><span class="comment">#由于拷贝完成后会在config中存在一个nginx文件夹，所以需要将它的内容移动到conf中</span></span><br><span class="line"><span class="built_in">mv</span> /mydata/nginx/conf/nginx/* /mydata/nginx/conf/</span><br><span class="line"><span class="built_in">rm</span> -rf /mydata/nginx/conf/nginx</span><br></pre></td></tr></table></figure>

<p>停止并删除原nginx容器</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker stop nginx</span><br><span class="line">docker <span class="built_in">rm</span> nginx</span><br></pre></td></tr></table></figure>

<p>创建新nginx容器</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">docker run -p 8081:80 --name nginx \</span><br><span class="line"> -v /mydata/nginx/html:/usr/share/nginx/html \</span><br><span class="line"> -v /mydata/nginx/logs:/var/log/nginx \</span><br><span class="line"> -v /mydata/nginx/conf/:/etc/nginx \</span><br><span class="line"> -d nginx:1.10</span><br><span class="line">docker update nginx --restart=always </span><br></pre></td></tr></table></figure>

<p>测试：&#x2F;mydata&#x2F;nginx&#x2F;html&#x2F;index.html</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo &#x27;&lt;h2&gt;hello nginx!&lt;/h2&gt;&#x27; &gt;/mydata/nginx/html/index.html</span><br></pre></td></tr></table></figure>

<p>创建&#x2F;mydata&#x2F;nginx&#x2F;html&#x2F;es&#x2F;fenci.txt </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">尚硅谷</span><br><span class="line">项目</span><br></pre></td></tr></table></figure>

<p>修改&#x2F;mydata&#x2F;elasticsearch&#x2F;plugins&#x2F;elasticsearch-analysis-ik-7.6.2&#x2F;config中的IKAnalyzer.cfg.xml</p>
<p>&#x2F;mydata&#x2F;elasticsearch&#x2F;plugins&#x2F;elasticsearch-analysis-ik-7.6.2&#x2F;config</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">properties</span> <span class="keyword">SYSTEM</span> <span class="string">&quot;http://java.sun.com/dtd/properties.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">comment</span>&gt;</span>IK Analyzer 扩展配置<span class="tag">&lt;/<span class="name">comment</span>&gt;</span></span><br><span class="line">	<span class="comment">&lt;!--用户可以在这里配置自己的扩展字典 --&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">&quot;ext_dict&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">entry</span>&gt;</span></span><br><span class="line">	 <span class="comment">&lt;!--用户可以在这里配置自己的扩展停止词字典--&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">&quot;ext_stopwords&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">entry</span>&gt;</span></span><br><span class="line">	<span class="comment">&lt;!--用户可以在这里配置远程扩展字典 --&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">&quot;remote_ext_dict&quot;</span>&gt;</span>http://192.168.6.128/es/fenci.txt<span class="tag">&lt;/<span class="name">entry</span>&gt;</span> </span><br><span class="line">	<span class="comment">&lt;!--用户可以在这里配置远程扩展停止词字典--&gt;</span></span><br><span class="line">	<span class="comment">&lt;!-- &lt;entry key=&quot;remote_ext_stopwords&quot;&gt;words_location&lt;/entry&gt; --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>重启es</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker restart elasticsearch</span><br></pre></td></tr></table></figure>





<p>扁平化处理：nested</p>
<h3 id="P125-SpringBoot-整合ES"><a href="#P125-SpringBoot-整合ES" class="headerlink" title="P125 SpringBoot 整合ES"></a>P125 SpringBoot 整合ES</h3><p>版本配置（springboot: 2.7.0）</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">elasticsearch.version</span>&gt;</span>7.6.2<span class="tag">&lt;/<span class="name">elasticsearch.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">spring-cloud.version</span>&gt;</span>2021.0.3<span class="tag">&lt;/<span class="name">spring-cloud.version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>引入es-client依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.elasticsearch.client<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>elasticsearch-rest-high-level-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>7.6.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h5 id="两个bug"><a href="#两个bug" class="headerlink" title="两个bug"></a>两个bug</h5><ol>
<li><p>无法启动springboot</p>
<p>解决：对齐springcloud版本和springboot版本</p>
</li>
<li><p>es-client无法配置</p>
<p>解决：对齐elasticsearch版本和es-client版本</p>
</li>
</ol>
<h3 id="P126-ES测试保存"><a href="#P126-ES测试保存" class="headerlink" title="P126 ES测试保存"></a>P126 ES测试保存</h3><p>RequestOptions</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> RequestOptions COMMON_OPTIONS;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        RequestOptions.<span class="type">Builder</span> <span class="variable">builder</span> <span class="operator">=</span> RequestOptions.DEFAULT.toBuilder();</span><br><span class="line"><span class="comment">//        builder.addHeader(&quot;Authorization&quot;, &quot;Bearer &quot; + TOKEN);</span></span><br><span class="line"><span class="comment">//        builder.setHttpAsyncResponseConsumerFactory(</span></span><br><span class="line"><span class="comment">//                new HttpAsyncResponseConsumerFactory</span></span><br><span class="line"><span class="comment">//                        .HeapBufferedResponseConsumerFactory(30 * 1024 * 1024 * 1024));</span></span><br><span class="line">        COMMON_OPTIONS = builder.build();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>测试索引</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">indexData</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">       <span class="type">IndexRequest</span> <span class="variable">indexRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IndexRequest</span>(<span class="string">&quot;user&quot;</span>);</span><br><span class="line">       indexRequest.id(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">       <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line">       user.setAge(<span class="number">18</span>);</span><br><span class="line">       user.setName(<span class="string">&quot;levy&quot;</span>);</span><br><span class="line">       <span class="type">String</span> <span class="variable">jsonString</span> <span class="operator">=</span> JSON.toJSONString(user);</span><br><span class="line">       indexRequest.source(jsonString, XContentType.JSON);</span><br><span class="line"></span><br><span class="line">       <span class="type">IndexResponse</span> <span class="variable">index</span> <span class="operator">=</span> client.index(indexRequest, GulimallElasticSearchConfig.COMMON_OPTIONS);</span><br><span class="line">       System.out.println(index);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<h3 id="P127-ES测试复杂检索"><a href="#P127-ES测试复杂检索" class="headerlink" title="P127 ES测试复杂检索"></a>P127 ES测试复杂检索</h3><p><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/client/java-rest/7.6/java-rest-high-search.html">Search API</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">searchData</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">       <span class="type">SearchRequest</span> <span class="variable">searchRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchRequest</span>();</span><br><span class="line">       <span class="comment">//1.1 指定索引</span></span><br><span class="line">       searchRequest.indices(<span class="string">&quot;bank&quot;</span>);</span><br><span class="line">       <span class="comment">//1.2 构造检索条件</span></span><br><span class="line">       <span class="type">SearchSourceBuilder</span> <span class="variable">sourceBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchSourceBuilder</span>();</span><br><span class="line">       sourceBuilder.query(QueryBuilders.matchQuery(<span class="string">&quot;address&quot;</span>, <span class="string">&quot;Mill&quot;</span>));</span><br><span class="line">       <span class="comment">//1.2.1 按年龄分布进行聚合</span></span><br><span class="line">       <span class="type">TermsAggregationBuilder</span> <span class="variable">ageAgg</span> <span class="operator">=</span> AggregationBuilders.terms(<span class="string">&quot;ageAgg&quot;</span>).field(<span class="string">&quot;age&quot;</span>).size(<span class="number">10</span>);</span><br><span class="line">       sourceBuilder.aggregation(ageAgg);</span><br><span class="line">       <span class="comment">//1.2.2 计算平均年龄</span></span><br><span class="line">       <span class="type">AvgAggregationBuilder</span> <span class="variable">ageAvg</span> <span class="operator">=</span> AggregationBuilders.avg(<span class="string">&quot;ageAvg&quot;</span>).field(<span class="string">&quot;age&quot;</span>);</span><br><span class="line">       sourceBuilder.aggregation(ageAvg);</span><br><span class="line">       <span class="comment">//1.2.3 计算平均薪资</span></span><br><span class="line">       <span class="type">AvgAggregationBuilder</span> <span class="variable">balanceAvg</span> <span class="operator">=</span> AggregationBuilders.avg(<span class="string">&quot;balanceAvg&quot;</span>).field(<span class="string">&quot;balance&quot;</span>);</span><br><span class="line">       sourceBuilder.aggregation(balanceAvg);</span><br><span class="line"></span><br><span class="line">       System.out.println(<span class="string">&quot;检索条件：&quot;</span> + sourceBuilder);</span><br><span class="line">       searchRequest.source(sourceBuilder);</span><br><span class="line">       <span class="comment">//2. 执行检索</span></span><br><span class="line">       <span class="type">SearchResponse</span> <span class="variable">searchResponse</span> <span class="operator">=</span> client.search(searchRequest, RequestOptions.DEFAULT);</span><br><span class="line">       System.out.println(<span class="string">&quot;检索结果：&quot;</span> + searchResponse);</span><br><span class="line">       <span class="comment">//3. 将检索结果封装为Bean</span></span><br><span class="line">       <span class="type">SearchHits</span> <span class="variable">hits</span> <span class="operator">=</span> searchResponse.getHits();</span><br><span class="line">       SearchHit[] searchHits = hits.getHits();</span><br><span class="line">       <span class="keyword">for</span> (SearchHit searchHit : searchHits) &#123;</span><br><span class="line">           <span class="type">String</span> <span class="variable">sourceAsString</span> <span class="operator">=</span> searchHit.getSourceAsString();</span><br><span class="line">           <span class="type">Account</span> <span class="variable">account</span> <span class="operator">=</span> JSON.parseObject(sourceAsString, Account.class);</span><br><span class="line">           System.out.println(account);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">//4. 获取聚合信息</span></span><br><span class="line">       <span class="type">Aggregations</span> <span class="variable">aggregations</span> <span class="operator">=</span> searchResponse.getAggregations();</span><br><span class="line">       <span class="type">Terms</span> <span class="variable">ageAgg1</span> <span class="operator">=</span> aggregations.get(<span class="string">&quot;ageAgg&quot;</span>);</span><br><span class="line">       <span class="keyword">for</span> (Terms.Bucket bucket : ageAgg1.getBuckets()) &#123;</span><br><span class="line">           <span class="type">String</span> <span class="variable">keyAsString</span> <span class="operator">=</span> bucket.getKeyAsString();</span><br><span class="line">           System.out.println(<span class="string">&quot;年龄：&quot;</span> + keyAsString + <span class="string">&quot; ==&gt; &quot;</span> + bucket.getDocCount());</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="type">Avg</span> <span class="variable">ageAvg1</span> <span class="operator">=</span> aggregations.get(<span class="string">&quot;ageAvg&quot;</span>);</span><br><span class="line">       System.out.println(<span class="string">&quot;平均年龄：&quot;</span> + ageAvg1.getValue());</span><br><span class="line"></span><br><span class="line">       <span class="type">Avg</span> <span class="variable">balanceAvg1</span> <span class="operator">=</span> aggregations.get(<span class="string">&quot;balanceAvg&quot;</span>);</span><br><span class="line">       System.out.println(<span class="string">&quot;平均薪资：&quot;</span> + balanceAvg1.getValue());</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<h3 id="P128-上架模型分析"><a href="#P128-上架模型分析" class="headerlink" title="P128 上架模型分析"></a>P128 上架模型分析</h3><p>商品Mapping</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">PUT product </span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">	<span class="attr">&quot;mappings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">		<span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">			<span class="attr">&quot;skuId&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">				<span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;long&quot;</span></span><br><span class="line">			<span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">			<span class="attr">&quot;spuId&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">				<span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span></span><br><span class="line">			<span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">			<span class="attr">&quot;skuTitle&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">				<span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;text&quot;</span><span class="punctuation">,</span></span><br><span class="line">				<span class="attr">&quot;analyzer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ik_smart&quot;</span></span><br><span class="line">			<span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">			<span class="attr">&quot;skuPrice&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">				<span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span></span><br><span class="line">			<span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">			<span class="attr">&quot;skuImg&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">				<span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span><span class="punctuation">,</span></span><br><span class="line">				<span class="attr">&quot;index&quot;</span><span class="punctuation">:</span> <span class="keyword">false</span><span class="punctuation">,</span></span><br><span class="line">				<span class="attr">&quot;doc_values&quot;</span><span class="punctuation">:</span> <span class="keyword">false</span></span><br><span class="line">			<span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">			<span class="attr">&quot;saleCount&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">				<span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;long&quot;</span></span><br><span class="line">			<span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">			<span class="attr">&quot;hasStock&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">				<span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;boolean&quot;</span></span><br><span class="line">			<span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">			<span class="attr">&quot;hotScore&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">				<span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;long&quot;</span></span><br><span class="line">			<span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">			<span class="attr">&quot;brandId&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">				<span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;long&quot;</span></span><br><span class="line">			<span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">			<span class="attr">&quot;catalogId&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">				<span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;long&quot;</span></span><br><span class="line">			<span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">			<span class="attr">&quot;brandName&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">				<span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span><span class="punctuation">,</span></span><br><span class="line">				<span class="attr">&quot;index&quot;</span><span class="punctuation">:</span> <span class="keyword">false</span><span class="punctuation">,</span></span><br><span class="line">				<span class="attr">&quot;doc_values&quot;</span><span class="punctuation">:</span> <span class="keyword">false</span></span><br><span class="line">			<span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">			<span class="attr">&quot;brandImg&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">				<span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span><span class="punctuation">,</span></span><br><span class="line">				<span class="attr">&quot;index&quot;</span><span class="punctuation">:</span> <span class="keyword">false</span><span class="punctuation">,</span></span><br><span class="line">				<span class="attr">&quot;doc_values&quot;</span><span class="punctuation">:</span> <span class="keyword">false</span></span><br><span class="line">			<span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">			<span class="attr">&quot;catalogName&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">				<span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span><span class="punctuation">,</span></span><br><span class="line">				<span class="attr">&quot;index&quot;</span><span class="punctuation">:</span> <span class="keyword">false</span><span class="punctuation">,</span></span><br><span class="line">				<span class="attr">&quot;doc_values&quot;</span><span class="punctuation">:</span> <span class="keyword">false</span></span><br><span class="line">			<span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">			<span class="attr">&quot;attrs&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">				<span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;nested&quot;</span><span class="punctuation">,</span></span><br><span class="line">				<span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">					<span class="attr">&quot;attrId&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">						<span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;long&quot;</span></span><br><span class="line">					<span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">					<span class="attr">&quot;attrName&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">						<span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span><span class="punctuation">,</span></span><br><span class="line">						<span class="attr">&quot;index&quot;</span><span class="punctuation">:</span> <span class="keyword">false</span><span class="punctuation">,</span></span><br><span class="line">						<span class="attr">&quot;doc_values&quot;</span><span class="punctuation">:</span> <span class="keyword">false</span></span><br><span class="line">					<span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">					<span class="attr">&quot;attrValue&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">						<span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span></span><br><span class="line">					<span class="punctuation">&#125;</span></span><br><span class="line">				<span class="punctuation">&#125;</span></span><br><span class="line">			<span class="punctuation">&#125;</span></span><br><span class="line">		<span class="punctuation">&#125;</span></span><br><span class="line">	<span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="P129-nested分析"><a href="#P129-nested分析" class="headerlink" title="P129 nested分析"></a>P129 nested分析</h3><p>Mapping指定nested后，数组不会被扁平化</p>
<h3 id="P130-商品上架"><a href="#P130-商品上架" class="headerlink" title="P130 商品上架"></a>P130 商品上架</h3><p>common: to.es.SkuEsModel</p>
<p>商品上架</p>
<p>&#x2F;product&#x2F;spuinfo&#x2F;{spuId}&#x2F;up</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping(value = &quot;/&#123;spuId&#125;/up&quot;)</span></span><br><span class="line">   <span class="keyword">public</span> R <span class="title function_">spuUp</span><span class="params">(<span class="meta">@PathVariable(&quot;spuId&quot;)</span> Long spuId)</span> &#123;</span><br><span class="line"></span><br><span class="line">       spuInfoService.up(spuId);</span><br><span class="line"></span><br><span class="line">       <span class="keyword">return</span> R.ok();</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>up_impl</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GlobalTransactional(rollbackFor = Exception.class)</span></span><br><span class="line">   <span class="comment">// @Transactional(rollbackFor = Exception.class)</span></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">up</span><span class="params">(Long spuId)</span> &#123;</span><br><span class="line"></span><br><span class="line">       <span class="comment">//1、查出当前spuId对应的所有sku信息,品牌的名字</span></span><br><span class="line">       List&lt;SkuInfoEntity&gt; skuInfoEntities = skuInfoService.getSkusBySpuId(spuId);</span><br><span class="line"></span><br><span class="line">       <span class="comment">//TODO 4、查出当前sku的所有可以被用来检索的规格属性</span></span><br><span class="line">       List&lt;ProductAttrValueEntity&gt; baseAttrs = productAttrValueService.baseAttrListforspu(spuId);</span><br><span class="line"></span><br><span class="line">       List&lt;Long&gt; attrIds = baseAttrs.stream().map(attr -&gt; &#123;</span><br><span class="line">           <span class="keyword">return</span> attr.getAttrId();</span><br><span class="line">       &#125;).collect(Collectors.toList());</span><br><span class="line"></span><br><span class="line">       List&lt;Long&gt; searchAttrIds = attrService.selectSearchAttrs(attrIds);</span><br><span class="line">       <span class="comment">//转换为Set集合</span></span><br><span class="line">       Set&lt;Long&gt; idSet = searchAttrIds.stream().collect(Collectors.toSet());</span><br><span class="line"></span><br><span class="line">       List&lt;SkuEsModel.Attrs&gt; attrsList = baseAttrs.stream().filter(item -&gt; &#123;</span><br><span class="line">           <span class="keyword">return</span> idSet.contains(item.getAttrId());</span><br><span class="line">       &#125;).map(item -&gt; &#123;</span><br><span class="line">           SkuEsModel.<span class="type">Attrs</span> <span class="variable">attrs</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SkuEsModel</span>.Attrs();</span><br><span class="line">           BeanUtils.copyProperties(item, attrs);</span><br><span class="line">           <span class="keyword">return</span> attrs;</span><br><span class="line">       &#125;).collect(Collectors.toList());</span><br><span class="line"></span><br><span class="line">       List&lt;Long&gt; skuIdList = skuInfoEntities.stream()</span><br><span class="line">               .map(SkuInfoEntity::getSkuId)</span><br><span class="line">               .collect(Collectors.toList());</span><br><span class="line">       <span class="comment">//TODO 1、发送远程调用，库存系统查询是否有库存</span></span><br><span class="line">       Map&lt;Long, Boolean&gt; stockMap = <span class="literal">null</span>;</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           <span class="type">R</span> <span class="variable">skuHasStock</span> <span class="operator">=</span> wareFeignService.getSkuHasStock(skuIdList);</span><br><span class="line">           <span class="comment">//</span></span><br><span class="line">           TypeReference&lt;List&lt;SkuHasStockVo&gt;&gt; typeReference = <span class="keyword">new</span> <span class="title class_">TypeReference</span>&lt;List&lt;SkuHasStockVo&gt;&gt;() &#123;&#125;;</span><br><span class="line">           stockMap = skuHasStock.getData(typeReference).stream()</span><br><span class="line">                   .collect(Collectors.toMap(SkuHasStockVo::getSkuId, item -&gt; item.getHasStock()));</span><br><span class="line">       &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">           log.error(<span class="string">&quot;库存服务查询异常：原因&#123;&#125;&quot;</span>,e);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="comment">//2、封装每个sku的信息</span></span><br><span class="line">       Map&lt;Long, Boolean&gt; finalStockMap = stockMap;</span><br><span class="line">       List&lt;SkuEsModel&gt; collect = skuInfoEntities.stream().map(sku -&gt; &#123;</span><br><span class="line">           <span class="comment">//组装需要的数据</span></span><br><span class="line">           <span class="type">SkuEsModel</span> <span class="variable">esModel</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SkuEsModel</span>();</span><br><span class="line">           esModel.setSkuPrice(sku.getPrice());</span><br><span class="line">           esModel.setSkuImg(sku.getSkuDefaultImg());</span><br><span class="line"></span><br><span class="line">           <span class="comment">//设置库存信息</span></span><br><span class="line">           <span class="keyword">if</span> (finalStockMap == <span class="literal">null</span>) &#123;</span><br><span class="line">               esModel.setHasStock(<span class="literal">true</span>);</span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">               esModel.setHasStock(finalStockMap.get(sku.getSkuId()));</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="comment">//TODO 2、热度评分。0</span></span><br><span class="line">           esModel.setHotScore(<span class="number">0L</span>);</span><br><span class="line"></span><br><span class="line">           <span class="comment">//TODO 3、查询品牌和分类的名字信息</span></span><br><span class="line">           <span class="type">BrandEntity</span> <span class="variable">brandEntity</span> <span class="operator">=</span> brandService.getById(sku.getBrandId());</span><br><span class="line">           esModel.setBrandName(brandEntity.getName());</span><br><span class="line">           esModel.setBrandId(brandEntity.getBrandId());</span><br><span class="line">           esModel.setBrandImg(brandEntity.getLogo());</span><br><span class="line"></span><br><span class="line">           <span class="type">CategoryEntity</span> <span class="variable">categoryEntity</span> <span class="operator">=</span> categoryService.getById(sku.getCatalogId());</span><br><span class="line">           esModel.setCatalogId(categoryEntity.getCatId());</span><br><span class="line">           esModel.setCatalogName(categoryEntity.getName());</span><br><span class="line"></span><br><span class="line">           <span class="comment">//设置检索属性</span></span><br><span class="line">           esModel.setAttrs(attrsList);</span><br><span class="line"></span><br><span class="line">           BeanUtils.copyProperties(sku,esModel);</span><br><span class="line"></span><br><span class="line">           <span class="keyword">return</span> esModel;</span><br><span class="line">       &#125;).collect(Collectors.toList());</span><br><span class="line"></span><br><span class="line">       <span class="comment">//TODO 5、将数据发给es进行保存：gulimall-search</span></span><br><span class="line">       <span class="type">R</span> <span class="variable">r</span> <span class="operator">=</span> searchFeignService.productStatusUp(collect);</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (r.getCode() == <span class="number">0</span>) &#123;</span><br><span class="line">           <span class="comment">//远程调用成功</span></span><br><span class="line">           <span class="comment">//TODO 6、修改当前spu的状态</span></span><br><span class="line">           <span class="built_in">this</span>.baseMapper.updaSpuStatus(spuId, ProductConstant.ProductStatusEnum.SPU_UP.getCode());</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           <span class="comment">//远程调用失败</span></span><br><span class="line">           <span class="comment">//TODO 7、重复调用？接口幂等性:重试机制</span></span><br><span class="line">           <span class="comment">//Feign调用流程</span></span><br><span class="line">           <span class="comment">/**</span></span><br><span class="line"><span class="comment">            * 1、 构造请求数据，将对象转为json</span></span><br><span class="line"><span class="comment">            * 2、 发送请求进行执行（执行成功会解码响应数据）</span></span><br><span class="line"><span class="comment">            * 3、 执行请求会有重试机制</span></span><br><span class="line"><span class="comment">            */</span></span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<h4 id="ES保存索引"><a href="#ES保存索引" class="headerlink" title="ES保存索引"></a>ES保存索引</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">	<span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">productStatusUp</span><span class="params">(List&lt;SkuEsModel&gt; skuEsModels)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">//1.在es中建立索引，建立号映射关系（doc/json/product-mapping.json）</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//2. 在ES中保存这些数据</span></span><br><span class="line">        <span class="type">BulkRequest</span> <span class="variable">bulkRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BulkRequest</span>();</span><br><span class="line">        <span class="keyword">for</span> (SkuEsModel skuEsModel : skuEsModels) &#123;</span><br><span class="line">            <span class="comment">//构造保存请求</span></span><br><span class="line">            <span class="type">IndexRequest</span> <span class="variable">indexRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IndexRequest</span>(EsConstant.PRODUCT_INDEX);</span><br><span class="line">            indexRequest.id(skuEsModel.getSkuId().toString());</span><br><span class="line">            <span class="type">String</span> <span class="variable">jsonString</span> <span class="operator">=</span> JSON.toJSONString(skuEsModel);</span><br><span class="line">            indexRequest.source(jsonString, XContentType.JSON);</span><br><span class="line">            bulkRequest.add(indexRequest);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="type">BulkResponse</span> <span class="variable">bulk</span> <span class="operator">=</span> esRestClient.bulk(bulkRequest, GulimallElasticSearchConfig.COMMON_OPTIONS);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//TODO 如果批量错误</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">hasFailures</span> <span class="operator">=</span> bulk.hasFailures();</span><br><span class="line"></span><br><span class="line">        List&lt;String&gt; collect = Arrays.asList(bulk.getItems()).stream().map(item -&gt; &#123;</span><br><span class="line">            <span class="keyword">return</span> item.getId();</span><br><span class="line">        &#125;).collect(Collectors.toList());</span><br><span class="line"></span><br><span class="line">        log.info(<span class="string">&quot;商品上架完成：&#123;&#125;&quot;</span>,collect);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> hasFailures;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h3 id><a href="#" class="headerlink" title></a></h3><h3 id="P134-Feign-原理"><a href="#P134-Feign-原理" class="headerlink" title="P134  Feign 原理"></a>P134  Feign 原理</h3><p>Feign调用流程<br>1、 构造请求数据，将对象转为json<br>2、 发送请求进行执行（执行成功会解码响应数据）<br>3、 执行请求会有重试机制</p>
<h3 id="P135-抽取响应结果"><a href="#P135-抽取响应结果" class="headerlink" title="P135 抽取响应结果"></a>P135 抽取响应结果</h3><p>利用fastjson进行反序列化</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;T&gt; T <span class="title function_">getData</span><span class="params">(TypeReference&lt;T&gt; typeReference)</span> &#123;</span><br><span class="line">    <span class="type">Object</span> <span class="variable">data</span> <span class="operator">=</span> get(<span class="string">&quot;data&quot;</span>);	<span class="comment">//默认是map</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">jsonString</span> <span class="operator">=</span> JSON.toJSONString(data);</span><br><span class="line">    <span class="type">T</span> <span class="variable">t</span> <span class="operator">=</span> JSON.parseObject(jsonString, typeReference);</span><br><span class="line">    <span class="keyword">return</span> t;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> R <span class="title function_">setData</span><span class="params">(Object data)</span> &#123;</span><br><span class="line">    put(<span class="string">&quot;data&quot;</span>,data);</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="P136-首页–整合Thymeleaf"><a href="#P136-首页–整合Thymeleaf" class="headerlink" title="P136 首页–整合Thymeleaf"></a>P136 首页–整合Thymeleaf</h3><p>引入依赖</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-boot-starter-thymeleaf&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<p>模板引擎</p>
<p>1）thymeleaf-starter: 关闭缓存</p>
<p>2）静态资源都放在static文件夹下就可以按照路径直接访问</p>
<p>3）页面都放在templates下，直接访问</p>
<p>​        SpringBoot 访问项目的时候默认访问index.html</p>
<p>ResourceProperties.java</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">private static final String[] CLASSPATH_RESOURCE_LOCATIONS = &#123; &quot;classpath:/META-INF/resources/&quot;,</span><br><span class="line">			&quot;classpath:/resources/&quot;, &quot;classpath:/static/&quot;, &quot;classpath:/public/&quot; &#125;;</span><br></pre></td></tr></table></figure>



<h3 id="P137-Thymeleaf–前端分类"><a href="#P137-Thymeleaf–前端分类" class="headerlink" title="P137 Thymeleaf–前端分类"></a>P137 Thymeleaf–前端分类</h3><p>Thymeleaf 语法</p>
<p>加命名空间</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span> <span class="attr">xmlns:th</span>=<span class="string">&quot;http://www.thymeleaf.org&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>Iteration– Using th:each</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span> <span class="attr">th:each</span>=<span class="string">&quot;category : $&#123;categories&#125;&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;#&quot;</span> <span class="attr">class</span>=<span class="string">&quot;header_main_left_a&quot;</span> <span class="attr">th:attr</span>=<span class="string">&quot;ctg-data = $&#123;category.catId&#125;&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">b</span> <span class="attr">th:text</span>=<span class="string">&quot;$&#123;category.name&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">b</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>模板引擎</p>
<ol>
<li><p>thymeleaf-starter: 关闭缓存</p>
</li>
<li><p>静态资源都放在static文件夹下就可以按照路径直接访问</p>
</li>
<li><p>页面放在templates下，直接访问</p>
<p>SpringBoot, 访问项目的时候，默认会找index</p>
</li>
<li><p>热部署（dev-tools）</p>
</li>
</ol>
<h5 id="热部署"><a href="#热部署" class="headerlink" title="热部署"></a>热部署</h5><ol>
<li><p>引入dev-tools</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-boot-devtools&lt;/artifactId&gt;</span><br><span class="line">    &lt;optional&gt;<span class="literal">true</span>&lt;/optional&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>修改完页面，使用 ctrl + shift + F9重新编译页面</p>
</li>
<li><p>thymeleaf-cache 设置为false</p>
</li>
</ol>
<h3 id="P138-渲染二三级分类"><a href="#P138-渲染二三级分类" class="headerlink" title="P138 渲染二三级分类"></a>P138 渲染二三级分类</h3><p>CategoryService:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">public Map&lt;String, Object&gt; getCatalogJson();</span><br></pre></td></tr></table></figure>

<p>原Code</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Map&lt;String, List&lt;Catelog2Vo&gt;&gt; <span class="title function_">getCatalogJson</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 1. 查出所有1级分类</span></span><br><span class="line">        List&lt;CategoryEntity&gt; level1Categories = getLevel1Categories();</span><br><span class="line">        <span class="comment">// 2. 封装数据</span></span><br><span class="line">        Map&lt;String, List&lt;Catelog2Vo&gt;&gt; listMap = level1Categories.stream().collect(Collectors.toMap(k -&gt; k.getCatId().toString(), v -&gt; &#123;</span><br><span class="line">            <span class="comment">// 查询1级分类的2级分类</span></span><br><span class="line">            List&lt;CategoryEntity&gt; level2s = baseMapper.selectList(<span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;CategoryEntity&gt;().eq(<span class="string">&quot;parent_cid&quot;</span>, v.getCatId()));</span><br><span class="line">            <span class="comment">// 封装2级分类</span></span><br><span class="line">            List&lt;Catelog2Vo&gt; catelog2Vos = <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">if</span> (level2s != <span class="literal">null</span>) &#123;</span><br><span class="line">                catelog2Vos = level2s.stream().map(l2 -&gt; &#123;</span><br><span class="line">                    <span class="type">Catelog2Vo</span> <span class="variable">catelog2Vo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Catelog2Vo</span>(v.getCatId().toString(),</span><br><span class="line">                            <span class="literal">null</span>,</span><br><span class="line">                            l2.getCatId().toString(),</span><br><span class="line">                            l2.getName());</span><br><span class="line">                    <span class="comment">// 查询2级分类的3级分类</span></span><br><span class="line">                    List&lt;CategoryEntity&gt; level3s = baseMapper.selectList(<span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;CategoryEntity&gt;().eq(<span class="string">&quot;parent_cid&quot;</span>, l2.getCatId()));</span><br><span class="line">                    <span class="keyword">if</span> (level3s != <span class="literal">null</span>) &#123;</span><br><span class="line">                        List&lt;Catelog2Vo.Catelog3Vo&gt; catelog3Vos = level3s.stream().map(l3 -&gt; &#123;</span><br><span class="line">                            Catelog2Vo.<span class="type">Catelog3Vo</span> <span class="variable">catelog3Vo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Catelog2Vo</span>.Catelog3Vo(l2.getCatId().toString(),</span><br><span class="line">                                    l3.getCatId().toString(),</span><br><span class="line">                                    l3.getName());</span><br><span class="line">                            <span class="keyword">return</span> catelog3Vo;</span><br><span class="line">                        &#125;).collect(Collectors.toList());</span><br><span class="line">                        catelog2Vo.setCatelog3List(catelog3Vos);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">return</span> catelog2Vo;</span><br><span class="line">                &#125;).collect(Collectors.toList());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> catelog2Vos;</span><br><span class="line">        &#125;));</span><br><span class="line">        <span class="keyword">return</span> listMap;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>查询优化</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Cacheable(value = &quot;category&quot;,key = &quot;#root.methodName&quot;)</span></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="keyword">public</span> Map&lt;String, List&lt;Catelog2Vo&gt;&gt; <span class="title function_">getCatalogJson</span><span class="params">()</span> &#123;</span><br><span class="line">       System.out.println(<span class="string">&quot;查询了数据库&quot;</span>);</span><br><span class="line"></span><br><span class="line">       <span class="comment">//将数据库的多次查询变为一次</span></span><br><span class="line">       List&lt;CategoryEntity&gt; selectList = <span class="built_in">this</span>.baseMapper.selectList(<span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">       <span class="comment">//1、查出所有分类</span></span><br><span class="line">       <span class="comment">//1、1）查出所有一级分类</span></span><br><span class="line">       List&lt;CategoryEntity&gt; level1Categorys = getParent_cid(selectList, <span class="number">0L</span>);</span><br><span class="line"></span><br><span class="line">       <span class="comment">//封装数据</span></span><br><span class="line">       Map&lt;String, List&lt;Catelog2Vo&gt;&gt; parentCid = level1Categorys.stream().collect(Collectors.toMap(k -&gt; k.getCatId().toString(), v -&gt; &#123;</span><br><span class="line">           <span class="comment">//1、每一个的一级分类,查到这个一级分类的二级分类</span></span><br><span class="line">           List&lt;CategoryEntity&gt; categoryEntities = getParent_cid(selectList, v.getCatId());</span><br><span class="line"></span><br><span class="line">           <span class="comment">//2、封装上面的结果</span></span><br><span class="line">           List&lt;Catelog2Vo&gt; catelog2Vos = <span class="literal">null</span>;</span><br><span class="line">           <span class="keyword">if</span> (categoryEntities != <span class="literal">null</span>) &#123;</span><br><span class="line">               catelog2Vos = categoryEntities.stream().map(l2 -&gt; &#123;</span><br><span class="line">                   <span class="type">Catelog2Vo</span> <span class="variable">catelog2Vo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Catelog2Vo</span>(v.getCatId().toString(), <span class="literal">null</span>, l2.getCatId().toString(), l2.getName().toString());</span><br><span class="line"></span><br><span class="line">                   <span class="comment">//1、找当前二级分类的三级分类封装成vo</span></span><br><span class="line">                   List&lt;CategoryEntity&gt; level3Catelog = getParent_cid(selectList, l2.getCatId());</span><br><span class="line"></span><br><span class="line">                   <span class="keyword">if</span> (level3Catelog != <span class="literal">null</span>) &#123;</span><br><span class="line">                       List&lt;Catelog2Vo.Category3Vo&gt; category3Vos = level3Catelog.stream().map(l3 -&gt; &#123;</span><br><span class="line">                           <span class="comment">//2、封装成指定格式</span></span><br><span class="line">                           Catelog2Vo.<span class="type">Category3Vo</span> <span class="variable">category3Vo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Catelog2Vo</span>.Category3Vo(l2.getCatId().toString(), l3.getCatId().toString(), l3.getName());</span><br><span class="line"></span><br><span class="line">                           <span class="keyword">return</span> category3Vo;</span><br><span class="line">                       &#125;).collect(Collectors.toList());</span><br><span class="line">                       catelog2Vo.setCatalog3List(category3Vos);</span><br><span class="line">                   &#125;</span><br><span class="line"></span><br><span class="line">                   <span class="keyword">return</span> catelog2Vo;</span><br><span class="line">               &#125;).collect(Collectors.toList());</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="keyword">return</span> catelog2Vos;</span><br><span class="line">       &#125;));</span><br><span class="line"></span><br><span class="line">       <span class="keyword">return</span> parentCid;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<h3 id="P139-nginx-反向代理"><a href="#P139-nginx-反向代理" class="headerlink" title="P139 nginx 反向代理"></a>P139 nginx 反向代理</h3><ul>
<li><p>修改host</p>
<p>C:\Windows\System32\drivers\etc\hosts</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">192.168.56.10 gulimall.com</span><br></pre></td></tr></table></figure>
</li>
<li><p>新建gulimall.conf</p>
<p>cp default.conf gulimall.conf</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen       80;</span><br><span class="line">    server_name  gulimall.com;</span><br><span class="line"></span><br><span class="line">    #charset koi8-r;</span><br><span class="line">    #access_log  /var/log/nginx/log/host.access.log  main;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        proxy_pass http://192.168.56.1:10000;</span><br><span class="line">    &#125;</span><br><span class="line">......</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="P140-nginx-负载均衡到网关"><a href="#P140-nginx-负载均衡到网关" class="headerlink" title="P140 nginx 负载均衡到网关"></a>P140 nginx 负载均衡到网关</h3><p>nginx官网：<a target="_blank" rel="noopener" href="https://nginx.org/en/docs/http/load_balancing.html">https://nginx.org/en/docs/http/load_balancing.html</a></p>
<p>修改nginx.conf</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">upstream gulimall &#123;</span><br><span class="line">	server 192.168.56.1:88;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>修改gulimall.conf</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">location / &#123;</span><br><span class="line">		proxy_set_head Host $host;</span><br><span class="line">        proxy_pass http://gulimall;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>gulimall-gateway 配置</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">- id: gulimall_host_route</span><br><span class="line">    uri: lb://gulimall-product</span><br><span class="line">    predicates:</span><br><span class="line">    - Host=gulimall.com,item.gulimall.com</span><br></pre></td></tr></table></figure>

<h3 id="P141-压力测试"><a href="#P141-压力测试" class="headerlink" title="P141 压力测试"></a>P141 压力测试</h3><p>性能指标</p>
<ul>
<li>响应时间</li>
<li>HPS 每秒点击次数</li>
<li>TPS 系统每秒处理交易数</li>
<li>QPS 系统每秒处理查询次数</li>
<li>最大响应时间</li>
<li>最少响应时间</li>
<li>90%响应时间</li>
<li>外部<ul>
<li>吞吐量</li>
<li>响应时间</li>
<li>错误率</li>
</ul>
</li>
</ul>
<h3 id="P143-JMeter-异常解决"><a href="#P143-JMeter-异常解决" class="headerlink" title="P143 JMeter 异常解决"></a>P143 JMeter 异常解决</h3><p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-CN/troubleshoot/windows-client/networking/connect-tcp-greater-than-5000-error-wsaenobufs-10055">尝试从大于 5000 的 TCP 端口连接时</a></p>
<p>修改注册表</p>
<p>HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters</p>
<blockquote>
<p>在” <strong>编辑”</strong> 菜单上，单击 <strong>“新建</strong>“，然后添加以下注册表项：<br>值名称：MaxUserPort<br>值类型：DWORD 值数据：65534 有效范围：5000-65534 (decimal) Default： 0x1388 (5000 decimal) Description： This parameter controls the maximum port number that is used when a program requests any available user port from the system. 通常，在 1024 (5000（包含 1024 和 5000）之间分配临时) 短期端口</p>
<p> 备注</p>
<p>一个额外的 TCPTimedWaitDelay 注册表参数确定关闭的端口在可以重用关闭的端口之前等待的时间。</p>
</blockquote>
<p>MaxUserPort 65534</p>
<p>TCPTimedWaitDelay  30</p>
<h3 id="P144-性能优化思路"><a href="#P144-性能优化思路" class="headerlink" title="P144 性能优化思路"></a>P144 性能优化思路</h3><p>CPU密集型，IO密集型</p>
<p>JVM，内存模型，垃圾回收</p>
<h3 id="P145-jvm-监控"><a href="#P145-jvm-监控" class="headerlink" title="P145 jvm 监控"></a>P145 jvm 监控</h3><ul>
<li>jconsole</li>
<li>jvisualvm<ul>
<li>安装插件</li>
</ul>
</li>
</ul>
<h3 id="P146-压力测试–中间件、全链路"><a href="#P146-压力测试–中间件、全链路" class="headerlink" title="P146 压力测试–中间件、全链路"></a>P146 压力测试–中间件、全链路</h3><p>docker 监控</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker stats</span><br></pre></td></tr></table></figure>

<p>Nginx 测试</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">192.168.56.10:8081</span><br></pre></td></tr></table></figure>

<p>网关测试</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://localhost:88/</span><br></pre></td></tr></table></figure>

<p>简单服务</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://localhost:10001/hello</span><br></pre></td></tr></table></figure>

<p>网关+简单服务</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://localhost:88/hello</span><br></pre></td></tr></table></figure>

<p>全链路（nginx+网关+简单服务）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://gulimall.com:8081/hello</span><br></pre></td></tr></table></figure>

<p>首页一级菜单渲染</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://localhost:10001/</span><br></pre></td></tr></table></figure>

<p>三级分类数据获取</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://localhost:10001/index/catalog.json</span><br></pre></td></tr></table></figure>

<p>首页全量数据获取</p>
<ul>
<li>配置jmeter-高级-从html文件获取所有内含的资源 √</li>
<li><strong>此处会卡死</strong>！！</li>
</ul>
<h4 id="优化方向"><a href="#优化方向" class="headerlink" title="优化方向"></a>优化方向</h4><ul>
<li>thymeleaf 开启缓存（貌似需要<strong>预热</strong>）</li>
<li>降低日志级别<ul>
<li>debug-&gt;error </li>
<li>吞吐量：1760</li>
</ul>
</li>
<li>加索引（效果显著）</li>
<li>优化业务代码</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://localhost:10001/index/catalog.json</span><br></pre></td></tr></table></figure>



<h3 id="压测结果"><a href="#压测结果" class="headerlink" title="@压测结果"></a>@压测结果</h3><table>
<thead>
<tr>
<th>压测内容</th>
<th>压测线程数</th>
<th>吞吐量&#x2F;s</th>
<th>90%响应时间</th>
<th>99%响应时间</th>
</tr>
</thead>
<tbody><tr>
<td>Nginx</td>
<td>50</td>
<td>7857</td>
<td>6</td>
<td>9</td>
</tr>
<tr>
<td>Gateway</td>
<td>50</td>
<td>24875</td>
<td>3</td>
<td>4</td>
</tr>
<tr>
<td>简单服务</td>
<td>50</td>
<td>48942</td>
<td>1</td>
<td>3</td>
</tr>
<tr>
<td>首页一级菜单渲染</td>
<td>50</td>
<td>730</td>
<td>82</td>
<td>135</td>
</tr>
<tr>
<td>首页渲染（开缓存）</td>
<td>50</td>
<td>800</td>
<td>76</td>
<td>128</td>
</tr>
<tr>
<td>首页渲染（开缓存、优化数据库、关日志）</td>
<td>50</td>
<td>1600</td>
<td>45</td>
<td>78</td>
</tr>
<tr>
<td>三级分类数据获取</td>
<td>50</td>
<td>6&#x2F;16</td>
<td>…</td>
<td>…</td>
</tr>
<tr>
<td>三级分类（优化业务）</td>
<td>50</td>
<td>300</td>
<td>204</td>
<td>297</td>
</tr>
<tr>
<td>三 级 分 类 （ 使 用redis 作为缓存）</td>
<td>50</td>
<td>2587</td>
<td>24</td>
<td>49</td>
</tr>
<tr>
<td>首页全量数据获取</td>
<td>50</td>
<td>37(卡死)</td>
<td></td>
<td></td>
</tr>
<tr>
<td>Nginx+Gateway</td>
<td>50</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>Gateway+简单服务</td>
<td>50</td>
<td>12150</td>
<td>7</td>
<td>16</td>
</tr>
<tr>
<td>全链路</td>
<td>50</td>
<td>1800</td>
<td>47</td>
<td>70</td>
</tr>
</tbody></table>
<h3 id="P147-简单优化"><a href="#P147-简单优化" class="headerlink" title="P147 简单优化"></a>P147 简单优化</h3><ul>
<li>thymeleaf 开缓存</li>
<li>优化数据库（开索引）</li>
<li>关日志</li>
</ul>
<h3 id="P148-nginx-动静分离"><a href="#P148-nginx-动静分离" class="headerlink" title="P148 nginx 动静分离"></a>P148 nginx 动静分离</h3><p>&#x2F;mydata&#x2F;nginx&#x2F;html&#x2F;static&#x2F;index&#x2F;…</p>
<p>nginx 配置 gulimall.conf</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">location /static/ &#123;</span><br><span class="line">	root   /usr/share/nginx/html;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="P149-模拟宕机"><a href="#P149-模拟宕机" class="headerlink" title="P149 模拟宕机"></a>P149 模拟宕机</h3><p>宕机配置</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-Xmx100m</span><br></pre></td></tr></table></figure>

<p>正常配置</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-Xmx1024m -Xms1024m -Xmn512m</span><br></pre></td></tr></table></figure>

<ul>
<li>Xmx 最大</li>
<li>Xms 最小</li>
<li>Xmn 新生代</li>
</ul>
<h3 id="P150-优化三级分类查询"><a href="#P150-优化三级分类查询" class="headerlink" title="P150 优化三级分类查询"></a>P150 优化三级分类查询</h3><p>见P138 优化代码</p>
<p>思路：原来是依次查询每一级分类的父分类；优化思路采用先查询所有，再依据父分类id找到每一级的所有父分类，优化后只需要一次数据库查询操作。</p>
<h3 id="P151-缓存与分布式锁"><a href="#P151-缓存与分布式锁" class="headerlink" title="P151 缓存与分布式锁"></a>P151 缓存与分布式锁</h3><p>哪些数据适合放入缓存？</p>
<ul>
<li>即时性、数据一致性要求不高</li>
<li>读多、写少</li>
</ul>
<p>本地缓存与缓存中间件</p>
<ul>
<li>本地缓存可使用Map，但是会有数据一致性问题</li>
<li>缓存中间件如redis</li>
</ul>
<h3 id="P152-整合redis"><a href="#P152-整合redis" class="headerlink" title="P152 整合redis"></a>P152 整合redis</h3><p><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-boot/docs/current/reference/html/using.html#using.build-systems.starters">spring-boot-starter-data-redis</a></p>
<ol>
<li><p>导入依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>yml配置</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">	<span class="attr">redis:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="number">192.168</span><span class="number">.56</span><span class="number">.10</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">6379</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>测试</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line">StringRedisTemplate stringRedisTemplate;</span><br><span class="line">   </span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testStringRedisTemplate</span><span class="params">()</span> &#123;</span><br><span class="line">	ValueOperations&lt;String, String&gt; ops = stringRedisTemplate.opsForValue();</span><br><span class="line">   </span><br><span class="line">	<span class="comment">// 保存</span></span><br><span class="line">	ops.set(<span class="string">&quot;hello&quot;</span>, <span class="string">&quot;world_&quot;</span> + UUID.randomUUID().toString());</span><br><span class="line">   </span><br><span class="line">	<span class="comment">// 查询</span></span><br><span class="line">	<span class="type">String</span> <span class="variable">hello</span> <span class="operator">=</span> ops.get(<span class="string">&quot;hello&quot;</span>);</span><br><span class="line">	System.out.println(<span class="string">&quot;保存的数据是：&quot;</span> + hello);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="P153-redis缓存三级分类"><a href="#P153-redis缓存三级分类" class="headerlink" title="P153 redis缓存三级分类"></a>P153 redis缓存三级分类</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">   <span class="keyword">public</span> Map&lt;String, List&lt;Catelog2Vo&gt;&gt; <span class="title function_">getCatalogJson</span><span class="params">()</span> &#123;</span><br><span class="line">       <span class="comment">// 给缓存中放json字符串，拿出的json字符串，逆转为对象类型【序列化与反序列化】</span></span><br><span class="line">       <span class="comment">//1. 加入缓存，缓存数据是json字符串</span></span><br><span class="line">       <span class="comment">//JSON跨语言，跨平台兼容</span></span><br><span class="line">       <span class="type">String</span> <span class="variable">catalogJson</span> <span class="operator">=</span> redisTemplate.opsForValue().get(<span class="string">&quot;catalogJson&quot;</span>);</span><br><span class="line">       <span class="keyword">if</span> (StringUtils.isNullOrEmpty(catalogJson)) &#123;</span><br><span class="line">           <span class="comment">//2. 缓存中没有，则查询数据库</span></span><br><span class="line">           Map&lt;String, List&lt;Catelog2Vo&gt;&gt; catalogJsonFromMb = getCatalogJsonFromMb();</span><br><span class="line">           <span class="type">String</span> <span class="variable">jsonString</span> <span class="operator">=</span> JSON.toJSONString(catalogJsonFromMb);</span><br><span class="line">           <span class="comment">//3. 查到的数据再放入缓存，将对象转为json放在缓存中</span></span><br><span class="line">           redisTemplate.opsForValue().set(<span class="string">&quot;catalogJson&quot;</span>, jsonString);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">//转为指定的对象</span></span><br><span class="line">       Map&lt;String, List&lt;Catelog2Vo&gt;&gt; result = JSON.parseObject(catalogJson, <span class="keyword">new</span> <span class="title class_">TypeReference</span>&lt;Map&lt;String, List&lt;Catelog2Vo&gt;&gt;&gt;() &#123;</span><br><span class="line">       &#125;);</span><br><span class="line">       <span class="keyword">return</span> result;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>内存泄漏问题</p>
<ul>
<li><p>和 lettuce 内部bug有关</p>
</li>
<li><p>springboot2.7没有遇到</p>
</li>
<li><p>&#96;&#96;&#96;<br><lettuce>6.1.8.RELEASE</lettuce></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">### P154 压测redis</span><br><span class="line"></span><br><span class="line">### P155 缓存问题</span><br><span class="line"></span><br><span class="line">* 缓存穿透</span><br><span class="line">  * 查询缓存中没有的数据</span><br><span class="line">  * 查询不存在的数据</span><br><span class="line">  * 解决：null结果缓存，并加入短暂过期时间</span><br><span class="line">* 缓存雪崩</span><br><span class="line">  * 缓存大面积同时失效</span><br><span class="line">  * 产生原因：设置了相同的过期时间</span><br><span class="line">  * 解决：过期时间加上随机值</span><br><span class="line">* 缓存穿透</span><br><span class="line">  * 热点数据在大量请求进来时正好失效</span><br><span class="line">  * 解决：加锁，一个请求查数据库，其它先等待</span><br><span class="line"></span><br><span class="line">### P156 本地锁</span><br><span class="line"></span><br><span class="line">```java</span><br><span class="line">public Map&lt;String, List&lt;Catelog2Vo&gt;&gt; getCatalogJsonFromMbWithLocalLock() &#123;</span><br><span class="line"></span><br><span class="line">        synchronized (this) &#123;</span><br><span class="line">            return getCatalogJsonFromMb();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Map&lt;String, List&lt;Catelog2Vo&gt;&gt; <span class="title function_">getCatalogJsonFromMb</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 得到锁以后，应该再去缓存中确定一次，如果没有才需要查询数据库</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">catalogJson</span> <span class="operator">=</span> redisTemplate.opsForValue().get(<span class="string">&quot;catalogJson&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (!StringUtils.isNullOrEmpty(catalogJson)) &#123;</span><br><span class="line">            <span class="comment">// 如果不为null，则直接放回</span></span><br><span class="line">            Map&lt;String, List&lt;Catelog2Vo&gt;&gt; result = JSON.parseObject(catalogJson, <span class="keyword">new</span> <span class="title class_">TypeReference</span>&lt;Map&lt;String, List&lt;Catelog2Vo&gt;&gt;&gt;() &#123;</span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 否则查询数据库</span></span><br><span class="line">        System.out.println(<span class="string">&quot;查询了数据库......&quot;</span>);</span><br><span class="line">    <span class="comment">// ......</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">jsonString</span> <span class="operator">=</span> JSON.toJSONString(listMap);</span><br><span class="line">        <span class="comment">//3. 查到的数据再放入缓存，将对象转为json放在缓存中</span></span><br><span class="line">        redisTemplate.opsForValue().set(<span class="string">&quot;catalogJson&quot;</span>, jsonString, <span class="number">1</span>, TimeUnit.DAYS);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> listMap;</span><br></pre></td></tr></table></figure>

<h3 id="P157-本地锁问题"><a href="#P157-本地锁问题" class="headerlink" title="P157 本地锁问题"></a>P157 本地锁问题</h3><p>本地锁只能锁住当前服务，分布式下，每一个服务都会查询一次数据库。</p>
<h3 id="P158-redis-实现分布锁"><a href="#P158-redis-实现分布锁" class="headerlink" title="P158 redis 实现分布锁"></a>P158 redis 实现分布锁</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * redis 实现分布锁</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">public</span> Map&lt;String, List&lt;Catelog2Vo&gt;&gt; <span class="title function_">getCatalogJsonFromMbWithRedisLock</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">       <span class="comment">//1. 占分布式锁，去redis占坑</span></span><br><span class="line">       <span class="type">String</span> <span class="variable">uuid</span> <span class="operator">=</span> UUID.randomUUID().toString();</span><br><span class="line">       <span class="type">Boolean</span> <span class="variable">lock</span> <span class="operator">=</span> redisTemplate.opsForValue().setIfAbsent(<span class="string">&quot;lock&quot;</span>, uuid, <span class="number">300</span>, TimeUnit.SECONDS);</span><br><span class="line">       <span class="keyword">if</span> (lock) &#123;</span><br><span class="line">           System.out.println(<span class="string">&quot;获取分布式锁成功！&quot;</span>);</span><br><span class="line">           Map&lt;String, List&lt;Catelog2Vo&gt;&gt; result = <span class="literal">null</span>;</span><br><span class="line">           <span class="keyword">try</span> &#123;</span><br><span class="line">               result = getCatalogJsonFromMb();</span><br><span class="line">           &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">               <span class="type">String</span> <span class="variable">script</span> <span class="operator">=</span> <span class="string">&quot;if redis.call(&#x27;get&#x27;, KEYS[1]) == ARGV[1] then return redis.call(&#x27;del&#x27;, KEYS[1]) else return 0 end&quot;</span>;</span><br><span class="line">               <span class="comment">// 删除锁</span></span><br><span class="line">               redisTemplate.execute(<span class="keyword">new</span> <span class="title class_">DefaultRedisScript</span>&lt;Long&gt;(script, Long.class),</span><br><span class="line">                       Arrays.asList(<span class="string">&quot;lock&quot;</span>),</span><br><span class="line">                       uuid);</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="comment">//先去redis查询下保证当前的锁是自己的</span></span><br><span class="line">           <span class="comment">//获取值对比，对比成功删除=原子性 lua脚本解锁</span></span><br><span class="line">           <span class="comment">// String lockValue = stringRedisTemplate.opsForValue().get(&quot;lock&quot;);</span></span><br><span class="line">           <span class="comment">// if (uuid.equals(lockValue)) &#123;</span></span><br><span class="line">           <span class="comment">//     //删除我自己的锁</span></span><br><span class="line">           <span class="comment">//     stringRedisTemplate.delete(&quot;lock&quot;);</span></span><br><span class="line">           <span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line">           <span class="keyword">return</span> result;</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           System.out.println(<span class="string">&quot;获取分布式锁失败...等待重试...&quot;</span>);</span><br><span class="line">           <span class="comment">// 加锁失败...重试机制</span></span><br><span class="line">           <span class="comment">// 休眠100ms</span></span><br><span class="line">           <span class="keyword">try</span> &#123;</span><br><span class="line">               TimeUnit.MILLISECONDS.sleep(<span class="number">100</span>);</span><br><span class="line">           &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">               e.printStackTrace();</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">return</span> getCatalogJsonFromMbWithRedisLock();</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<h3 id="P159-redisson"><a href="#P159-redisson" class="headerlink" title="P159 redisson"></a>P159 redisson</h3><p><a target="_blank" rel="noopener" href="https://github.com/redisson/redisson/wiki/2.-%E9%85%8D%E7%BD%AE%E6%96%B9%E6%B3%95">redisson_doc</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedissonConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(destroyMethod=&quot;shutdown&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> RedissonClient <span class="title function_">redisson</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">// 1. 创建配置</span></span><br><span class="line">        <span class="type">Config</span> <span class="variable">config</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Config</span>();</span><br><span class="line">        <span class="comment">//可以用&quot;rediss://&quot;来启用SSL连接</span></span><br><span class="line">        config.useSingleServer().setAddress(<span class="string">&quot;redis://192.168.56.10:6379&quot;</span>);</span><br><span class="line">        <span class="comment">// 2. 根据config创建RedissonClient实例</span></span><br><span class="line">        <span class="type">RedissonClient</span> <span class="variable">redisson</span> <span class="operator">=</span> Redisson.create(config);</span><br><span class="line">        <span class="keyword">return</span> redisson;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="P160-lock锁测试"><a href="#P160-lock锁测试" class="headerlink" title="P160 lock锁测试"></a>P160 lock锁测试</h3><p>redisson特点</p>
<ul>
<li>锁默认超时时间为30s（可避免服务异常中止时未解锁的问题）</li>
<li>业务超时将自动续期</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line">   RedissonClient redisson;</span><br><span class="line"></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line">   <span class="meta">@GetMapping(value = &quot;/hello&quot;)</span></span><br><span class="line">   <span class="keyword">public</span> String <span class="title function_">hello</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">       <span class="comment">//1、获取一把锁，只要锁的名字一样，就是同一把锁</span></span><br><span class="line">       <span class="type">RLock</span> <span class="variable">myLock</span> <span class="operator">=</span> redisson.getLock(<span class="string">&quot;my-lock&quot;</span>);</span><br><span class="line"></span><br><span class="line">       <span class="comment">//2、加锁</span></span><br><span class="line">       myLock.lock();      <span class="comment">//阻塞式等待。默认加的锁都是30s</span></span><br><span class="line">       <span class="comment">//1）、锁的自动续期，如果业务超长，运行期间自动锁上新的30s。不用担心业务时间长，锁自动过期被删掉</span></span><br><span class="line">       <span class="comment">//2）、加锁的业务只要运行完成，就不会给当前锁续期，即使不手动解锁，锁默认会在30s内自动过期，不会产生死锁问题</span></span><br><span class="line">       <span class="comment">// myLock.lock(10,TimeUnit.SECONDS);   //10秒钟自动解锁,自动解锁时间一定要大于业务执行时间</span></span><br><span class="line">       <span class="comment">//问题：在锁时间到了以后，不会自动续期</span></span><br><span class="line">       <span class="comment">//1、如果我们传递了锁的超时时间，就发送给redis执行脚本，进行占锁，默认超时就是 我们制定的时间</span></span><br><span class="line">       <span class="comment">//2、如果我们指定锁的超时时间，就使用 lockWatchdogTimeout = 30 * 1000 【看门狗默认时间】</span></span><br><span class="line">       <span class="comment">//只要占锁成功，就会启动一个定时任务【重新给锁设置过期时间，新的过期时间就是看门狗的默认时间】,每隔10秒都会自动的再次续期，续成30秒</span></span><br><span class="line">       <span class="comment">// internalLockLeaseTime 【看门狗时间】 / 3， 10s</span></span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           System.out.println(<span class="string">&quot;加锁成功，执行业务...&quot;</span> + Thread.currentThread().getId());</span><br><span class="line">           <span class="keyword">try</span> &#123;</span><br><span class="line">               TimeUnit.SECONDS.sleep(<span class="number">20</span>);</span><br><span class="line">           &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">               e.printStackTrace();</span><br><span class="line">           &#125;</span><br><span class="line">       &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">           ex.printStackTrace();</span><br><span class="line">       &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">           <span class="comment">//3、解锁  假设解锁代码没有运行，Redisson会不会出现死锁</span></span><br><span class="line">           System.out.println(<span class="string">&quot;释放锁...&quot;</span> + Thread.currentThread().getId());</span><br><span class="line">           myLock.unlock();</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">return</span> <span class="string">&quot;hello&quot;</span>;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>



<h3 id="P161-lock看门狗原理"><a href="#P161-lock看门狗原理" class="headerlink" title="P161 lock看门狗原理"></a>P161 lock看门狗原理</h3><ul>
<li>myLock.lock() <ul>
<li>不指定超时时间，默认为30s</li>
<li>业务未执行完成会自动续期，internalLockLeaseTime 【看门狗时间】 &#x2F; 3， 10s</li>
</ul>
</li>
<li>myLock.lock(10,TimeUnit.SECONDS)<ul>
<li>指定超时时间不会自动续期</li>
</ul>
</li>
</ul>
<h3 id="P162-读写锁"><a href="#P162-读写锁" class="headerlink" title="P162 读写锁"></a>P162 读写锁</h3><ul>
<li>写锁是排他锁&#x2F;互斥锁，读锁是共享锁</li>
<li>redisson.getReadWriteLock(“rw-lock”)</li>
<li>rLock &#x3D; lock.writeLock()</li>
<li>rLock.lock();</li>
<li>rLock.unlock();</li>
<li>rLock &#x3D; lock.readLock();</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line">   <span class="meta">@GetMapping(value = &quot;/write&quot;)</span></span><br><span class="line">   <span class="keyword">public</span> String <span class="title function_">write</span><span class="params">()</span> &#123;</span><br><span class="line">       <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">       <span class="type">RReadWriteLock</span> <span class="variable">lock</span> <span class="operator">=</span> redisson.getReadWriteLock(<span class="string">&quot;rw-lock&quot;</span>);</span><br><span class="line">       <span class="type">RLock</span> <span class="variable">rLock</span> <span class="operator">=</span> lock.writeLock();</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           rLock.lock();</span><br><span class="line">           s = UUID.randomUUID().toString();</span><br><span class="line">           ValueOperations&lt;String, String&gt; ops = redisTemplate.opsForValue();</span><br><span class="line">           ops.set(<span class="string">&quot;writeValue&quot;</span>, s);</span><br><span class="line">           Thread.sleep(<span class="number">10000</span>);</span><br><span class="line">       &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">           e.printStackTrace();</span><br><span class="line">       &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">           rLock.unlock();</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span>  s;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@ResponseBody</span></span><br><span class="line">   <span class="meta">@GetMapping(value = &quot;/read&quot;)</span></span><br><span class="line">   <span class="keyword">public</span> String <span class="title function_">read</span><span class="params">()</span> &#123;</span><br><span class="line">       <span class="type">RReadWriteLock</span> <span class="variable">lock</span> <span class="operator">=</span> redisson.getReadWriteLock(<span class="string">&quot;rw-lock&quot;</span>);</span><br><span class="line">       <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">       <span class="type">RLock</span> <span class="variable">rLock</span> <span class="operator">=</span> lock.readLock();</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           rLock.lock();</span><br><span class="line">           ValueOperations&lt;String, String&gt; ops = redisTemplate.opsForValue();</span><br><span class="line">           s = ops.get(<span class="string">&quot;writeValue&quot;</span>);</span><br><span class="line">       &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">           e.printStackTrace();</span><br><span class="line">       &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">           rLock.unlock();</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> s;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<h3 id="P163-读写锁补充"><a href="#P163-读写锁补充" class="headerlink" title="P163 读写锁补充"></a>P163 读写锁补充</h3><ul>
<li>修改期间，写锁是一个排它锁（互斥锁、独享锁），读锁是一个共享锁<ul>
<li>读 + 读：相当于无锁、并发读</li>
<li>写 + 读：必须等待写锁释放</li>
<li>写 + 写：阻塞方式</li>
<li>读 + 写：有读锁，写也需要等待</li>
</ul>
</li>
<li>只要有写的存在，都必须等待</li>
</ul>
<h3 id="P164-闭锁"><a href="#P164-闭锁" class="headerlink" title="P164 闭锁"></a>P164 闭锁</h3><p>CountDownLatch</p>
<ul>
<li>door.trySetCount(5)</li>
<li>door.await()</li>
<li>door.countDown()</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 放假、锁门</span></span><br><span class="line"><span class="comment">    * 1班没人了</span></span><br><span class="line"><span class="comment">    * 5个班，全部走完，我们才可以锁大门</span></span><br><span class="line"><span class="comment">    * 分布式闭锁</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"></span><br><span class="line">   <span class="meta">@GetMapping(value = &quot;/lockDoor&quot;)</span></span><br><span class="line">   <span class="meta">@ResponseBody</span></span><br><span class="line">   <span class="keyword">public</span> String <span class="title function_">lockDoor</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line"></span><br><span class="line">       <span class="type">RCountDownLatch</span> <span class="variable">door</span> <span class="operator">=</span> redisson.getCountDownLatch(<span class="string">&quot;door&quot;</span>);</span><br><span class="line">       door.trySetCount(<span class="number">5</span>);</span><br><span class="line">       door.await();       <span class="comment">//等待闭锁完成</span></span><br><span class="line"></span><br><span class="line">       <span class="keyword">return</span> <span class="string">&quot;放假了...&quot;</span>;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@GetMapping(value = &quot;/gogogo/&#123;id&#125;&quot;)</span></span><br><span class="line">   <span class="meta">@ResponseBody</span></span><br><span class="line">   <span class="keyword">public</span> String <span class="title function_">gogogo</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id)</span> &#123;</span><br><span class="line">       <span class="type">RCountDownLatch</span> <span class="variable">door</span> <span class="operator">=</span> redisson.getCountDownLatch(<span class="string">&quot;door&quot;</span>);</span><br><span class="line">       door.countDown();       <span class="comment">//计数-1</span></span><br><span class="line"></span><br><span class="line">       <span class="keyword">return</span> id + <span class="string">&quot;班的人都走了...&quot;</span>;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<h3 id="P165-信号量"><a href="#P165-信号量" class="headerlink" title="P165 信号量"></a>P165 信号量</h3><p>Semaphore</p>
<ul>
<li>可用于限流</li>
<li>acquire()</li>
<li>release()</li>
<li>tryAcquire()</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 车库停车</span></span><br><span class="line"><span class="comment">    * 3车位</span></span><br><span class="line"><span class="comment">    * 信号量也可以做分布式限流</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@GetMapping(value = &quot;/park&quot;)</span></span><br><span class="line">   <span class="meta">@ResponseBody</span></span><br><span class="line">   <span class="keyword">public</span> String <span class="title function_">park</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line"></span><br><span class="line">       <span class="type">RSemaphore</span> <span class="variable">park</span> <span class="operator">=</span> redisson.getSemaphore(<span class="string">&quot;park&quot;</span>);</span><br><span class="line">       park.acquire();     <span class="comment">//获取一个信号、获取一个值,占一个车位</span></span><br><span class="line">       <span class="type">boolean</span> <span class="variable">flag</span> <span class="operator">=</span> park.tryAcquire();</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (flag) &#123;</span><br><span class="line">           <span class="comment">//执行业务</span></span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           <span class="keyword">return</span> <span class="string">&quot;error&quot;</span>;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">return</span> <span class="string">&quot;ok=&gt;&quot;</span> + flag;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@GetMapping(value = &quot;/go&quot;)</span></span><br><span class="line">   <span class="meta">@ResponseBody</span></span><br><span class="line">   <span class="keyword">public</span> String <span class="title function_">go</span><span class="params">()</span> &#123;</span><br><span class="line">       <span class="type">RSemaphore</span> <span class="variable">park</span> <span class="operator">=</span> redisson.getSemaphore(<span class="string">&quot;park&quot;</span>);</span><br><span class="line">       park.release();     <span class="comment">//释放一个车位</span></span><br><span class="line">       <span class="keyword">return</span> <span class="string">&quot;ok&quot;</span>;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<h3 id="P166-缓存一致性问题"><a href="#P166-缓存一致性问题" class="headerlink" title="P166 缓存一致性问题"></a>P166 缓存一致性问题</h3><ul>
<li>原则：对一致性、时效性要求高的数据，不应该放在缓存</li>
<li>缓存数据应该是读多、写少、允许暂时的数据不一致</li>
<li>解决：<ul>
<li>双写模式：更新数据库同时修改缓存</li>
<li>失效模式：更新数据直接删缓存</li>
<li>设置过期时间</li>
<li>读写锁</li>
<li>cannal：利用数据库的备份</li>
</ul>
</li>
</ul>
<h3 id="P167-168-SpringCache"><a href="#P167-168-SpringCache" class="headerlink" title="P167-168 SpringCache"></a>P167-168 SpringCache</h3><p><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-framework/docs/current/reference/html/integration.html#cache">springcache_doc</a></p>
<ol>
<li><p>引入依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-cache<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>配置</p>
<ol>
<li><p>自动配置</p>
<ul>
<li>CacheAutoConfiguration 会引入 RedisAutoConfiguration</li>
<li>自动配置了RedisCacheManager</li>
</ul>
</li>
<li><p>配置redis作为缓存</p>
<p>application.properties</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">spring.cache.type=redis</span></span><br></pre></td></tr></table></figure></li>
</ol>
</li>
<li><p>测试</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">	<span class="meta">@Cacheable(&#123;&quot;category&quot;&#125;)</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;CategoryEntity&gt; <span class="title function_">getLevel1Categories</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;查询一级分类...&quot;</span>);</span><br><span class="line">        <span class="type">long</span> <span class="variable">l</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        List&lt;CategoryEntity&gt; categoryEntities = baseMapper.selectList(<span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;CategoryEntity&gt;().eq(<span class="string">&quot;parent_cid&quot;</span>, <span class="number">0</span>));</span><br><span class="line"><span class="comment">//        System.out.println(&quot;消耗时间：&quot; + (System.currentTimeMillis() - l));</span></span><br><span class="line">        <span class="keyword">return</span> categoryEntities;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="P169-cacheable-细节设置"><a href="#P169-cacheable-细节设置" class="headerlink" title="P169 @cacheable 细节设置"></a>P169 @cacheable 细节设置</h3><ol>
<li><p>指定生成的缓存使用的key，接收spEL</p>
<p><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-framework/docs/current/reference/html/integration.html#cache-spel-context">doc</a></p>
</li>
<li><p>指定缓存的存活时间</p>
<p>application.properties</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring.cache.redis.time-to-live</span>=<span class="string">3600000</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>将数据保存为json</p>
</li>
</ol>
<h3 id="P170-自定义缓存配置"><a href="#P170-自定义缓存配置" class="headerlink" title="P170 自定义缓存配置"></a>P170 自定义缓存配置</h3><p>原理：</p>
<p>CacheAutoConfiguration -&gt; RedisCacheConfiguration -&gt; RedisCacheManager -&gt; RedisCacheConfiguration (如果有就用已有的，没有就用默认配置) -&gt; 想改缓存的配置，只需要给容器中放一个 RedisCacheConfiguration </p>
<p>默认的RedisCacheConfiguration </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> RedisCacheConfiguration <span class="title function_">defaultCacheConfig</span><span class="params">(<span class="meta">@Nullable</span> ClassLoader classLoader)</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="type">DefaultFormattingConversionService</span> <span class="variable">conversionService</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultFormattingConversionService</span>();</span><br><span class="line"></span><br><span class="line">	registerDefaultConverters(conversionService);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RedisCacheConfiguration</span>(Duration.ZERO, <span class="literal">true</span>, <span class="literal">true</span>, CacheKeyPrefix.simple(),</span><br><span class="line">			SerializationPair.fromSerializer(RedisSerializer.string()),</span><br><span class="line">			SerializationPair.fromSerializer(RedisSerializer.java(classLoader)), conversionService);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>修改缓存配置–新建CacheConfig.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableConfigurationProperties(CacheProperties.class)</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableCaching</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CacheConfig</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">//    @Autowired</span></span><br><span class="line"><span class="comment">//    CacheProperties cacheProperties;</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    RedisCacheConfiguration <span class="title function_">redisCacheConfiguration</span><span class="params">(CacheProperties cacheProperties)</span> &#123;</span><br><span class="line">        <span class="type">RedisCacheConfiguration</span> <span class="variable">config</span> <span class="operator">=</span> RedisCacheConfiguration.defaultCacheConfig();</span><br><span class="line"><span class="comment">//        config = config.entryTtl();</span></span><br><span class="line">        config = config.serializeKeysWith(RedisSerializationContext.SerializationPair.fromSerializer(RedisSerializer.string()));</span><br><span class="line">        config = config.serializeValuesWith(RedisSerializationContext.SerializationPair.fromSerializer(RedisSerializer.json()));</span><br><span class="line">        <span class="comment">// 启用配置文件中的配置</span></span><br><span class="line">        CacheProperties.<span class="type">Redis</span> <span class="variable">redisProperties</span> <span class="operator">=</span> cacheProperties.getRedis();</span><br><span class="line">        <span class="keyword">if</span> (redisProperties.getTimeToLive() != <span class="literal">null</span>) &#123;</span><br><span class="line">            config = config.entryTtl(redisProperties.getTimeToLive());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (redisProperties.getKeyPrefix() != <span class="literal">null</span>) &#123;</span><br><span class="line">            config = config.prefixCacheNameWith(redisProperties.getKeyPrefix());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!redisProperties.isCacheNullValues()) &#123;</span><br><span class="line">            config = config.disableCachingNullValues();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!redisProperties.isUseKeyPrefix()) &#123;</span><br><span class="line">            config = config.disableKeyPrefix();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> config;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>设置前缀+缓存空值</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring.cache.type</span>=<span class="string">redis</span></span><br><span class="line"><span class="attr">spring.cache.redis.time-to-live</span>=<span class="string">3600000</span></span><br><span class="line"><span class="attr">spring.cache.redis.key-prefix</span>=<span class="string">CACHE_</span></span><br><span class="line"><span class="attr">spring.cache.redis.use-key-prefix</span>=<span class="string">true</span></span><br><span class="line"><span class="comment"># 是否缓存空值</span></span><br><span class="line"><span class="attr">spring.cache.redis.cache-null-values</span>=<span class="string">true</span></span><br></pre></td></tr></table></figure>

<h3 id="P171-CacheEvict"><a href="#P171-CacheEvict" class="headerlink" title="P171  @CacheEvict"></a>P171  @CacheEvict</h3><p>清除缓存@CacheEvict</p>
<p>批量操作@Caching</p>
<p>example</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 级联更新所有关联的数据</span></span><br><span class="line"><span class="comment">     *<span class="doctag">@CacheEvict</span>: 失效模式</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> category</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="comment">//    @CacheEvict(value = &#123;&quot;category&quot;&#125;, key = &quot;&#x27;getLevel1Categories&#x27;&quot;)</span></span><br><span class="line">    <span class="meta">@CacheEvict(value = &#123;&quot;category&quot;&#125;, allEntries = true)</span></span><br><span class="line"><span class="comment">//    @Caching(evict = &#123;</span></span><br><span class="line"><span class="comment">//            @CacheEvict(value = &#123;&quot;category&quot;&#125;, key = &quot;&#x27;getLevel1Categories&#x27;&quot;),</span></span><br><span class="line"><span class="comment">//            @CacheEvict(value = &#123;&quot;category&quot;&#125;, key = &quot;&#x27;getCatalogJson&#x27;&quot;)</span></span><br><span class="line"><span class="comment">//    &#125;)</span></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">updateCascade</span><span class="params">(CategoryEntity category)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.updateById(category);</span><br><span class="line">        categoryBrandRelationService.updateCategory(category.getCatId(), category.getName());</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h3 id="P172-SpringCache的不足"><a href="#P172-SpringCache的不足" class="headerlink" title="P172 SpringCache的不足"></a>P172 SpringCache的不足</h3><ol>
<li>读模式<ul>
<li>缓存穿透：查询一个null数据；解决：缓存空数据，cache-null-values&#x3D;true</li>
<li>缓存雪崩：大量的key同时过期；解决：加随机时间</li>
<li>缓存击穿：大量并发进来查询一个正好过期的数据；解决：加锁，默认是无加锁的，sync&#x3D;true</li>
</ul>
</li>
<li>写模式（缓存一致性问题）<ol>
<li>读写加锁</li>
<li>引入Canal，感知到mysql的更新去更新缓存</li>
<li>读多写多，直接查询数据库</li>
</ol>
</li>
</ol>
<p>总结：</p>
<ol>
<li>常规数据（读多写少，即时性、一致性要求不高的数据），完全可以用Spring-Cache；写模式，只要缓存的数据有过期时间就足够了。</li>
<li>特殊数据：特殊设计</li>
</ol>
<h3 id="P173-检索服务"><a href="#P173-检索服务" class="headerlink" title="P173 检索服务"></a>P173 检索服务</h3><p>gulimall-search</p>
<ol>
<li><p>加thymeleaf索引</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-thymeleaf<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>index.html 加命名空间</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span> <span class="attr">xmlns:th</span>=<span class="string">&quot;http://www.thymeleaf.org&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>hosts 修改search.gulimall.com 对应ip</p>
<p>C:\Windows\System32\drivers\etc\hosts</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">192.168.56.10 search.gulimall.com</span><br><span class="line">192.168.56.10 gulimall.com</span><br></pre></td></tr></table></figure>
</li>
<li><p>配置nginx</p>
<p>gulimall.conf</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen       80;</span><br><span class="line">    server_name  gulimall.com *.gulimall.com;</span><br><span class="line"></span><br><span class="line">    #charset koi8-r;</span><br><span class="line">    #access_log  /var/log/nginx/log/host.access.log  main;</span><br><span class="line"></span><br><span class="line">    location /static/ &#123;</span><br><span class="line">        root   /usr/share/nginx/html;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        proxy_set_header Host $host;</span><br><span class="line">        proxy_pass http://gulimall;</span><br><span class="line">        # proxy_pass http://192.168.56.1:10001;</span><br><span class="line">    &#125;</span><br><span class="line">   	...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>重启nginx</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker restart nginx</span><br></pre></td></tr></table></figure>
</li>
<li><p>修改网关路由配置</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">id:</span> <span class="string">gulimall_search_route</span></span><br><span class="line">    <span class="attr">uri:</span> <span class="string">lb://gulimall-search</span></span><br><span class="line">    <span class="attr">predicates:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">Host=search.gulimall.com</span></span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="P174-调整页面跳转"><a href="#P174-调整页面跳转" class="headerlink" title="P174 调整页面跳转"></a>P174 调整页面跳转</h3><ol>
<li><p>添加dev-tools</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-boot-devtools&lt;/artifactId&gt;</span><br><span class="line">    &lt;optional&gt;true&lt;/optional&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>关thymeleaf缓存</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">spring.thymeleaf.cache=false</span><br></pre></td></tr></table></figure>
</li>
<li><p>首页跳转</p>
</li>
<li><p>搜索跳转</p>
</li>
</ol>
<h3 id="P175-检索查询参数模型分析"><a href="#P175-检索查询参数模型分析" class="headerlink" title="P175 检索查询参数模型分析"></a>P175 检索查询参数模型分析</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SearchParam</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 页面传递过来的全文匹配关键字</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String keyword;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 品牌id,可以多选</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;Long&gt; brandId;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 三级分类id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Long catalog3Id;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 排序条件：sort=price/salecount/hotscore_desc/asc</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String sort;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 是否显示有货</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer hasStock;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 价格区间查询</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String skuPrice;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 按照属性进行筛选</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;String&gt; attrs;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 页码</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">Integer</span> <span class="variable">pageNum</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 原生的所有查询条件</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String _queryString;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="P176-检索返回结果模型分析"><a href="#P176-检索返回结果模型分析" class="headerlink" title="P176 检索返回结果模型分析"></a>P176 检索返回结果模型分析</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SearchResult</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;SkuEsModel&gt; products;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 分页信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer pageNum;</span><br><span class="line">    <span class="keyword">private</span> Long total;</span><br><span class="line">    <span class="keyword">private</span> Integer totalPages;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;BrandVo&gt; brands;</span><br><span class="line">    <span class="keyword">private</span> List&lt;CatalogVo&gt; catalogs;</span><br><span class="line">    <span class="keyword">private</span> List&lt;AttrVo&gt; attrs;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Data</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">BrandVo</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> Long brandId;</span><br><span class="line">        <span class="keyword">private</span> String brandName;</span><br><span class="line">        <span class="keyword">private</span> String brandImg;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Data</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">CatalogVo</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> Long catalogId;</span><br><span class="line">        <span class="keyword">private</span> String catalogName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Data</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">AttrVo</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> Long attrId;</span><br><span class="line">        <span class="keyword">private</span> String attrName;</span><br><span class="line">        <span class="keyword">private</span> List&lt;String&gt; attrValue;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="P177-检索DSL–查询"><a href="#P177-检索DSL–查询" class="headerlink" title="P177 检索DSL–查询"></a>P177 检索DSL–查询</h3><p>kibana</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">GET /product/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;bool&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;must&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;skuTitle&quot;</span><span class="punctuation">:</span> <span class="string">&quot;华为&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;filter&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;term&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;hasStock&quot;</span><span class="punctuation">:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;term&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;catalogId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;225&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;terms&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;brandId&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="string">&quot;9&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;1&quot;</span></span><br><span class="line">          <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;nested&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;attrs&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;bool&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;filter&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="punctuation">&#123;</span><span class="attr">&quot;terms&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                  <span class="attr">&quot;attrs.attrId&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                    <span class="string">&quot;8&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="string">&quot;15&quot;</span></span><br><span class="line">                  <span class="punctuation">]</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br><span class="line">              <span class="punctuation">]</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;sort&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;skuPrice&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;order&quot;</span><span class="punctuation">:</span> <span class="string">&quot;desc&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="P178-检索DSL–聚合"><a href="#P178-检索DSL–聚合" class="headerlink" title="P178 检索DSL–聚合"></a>P178 检索DSL–聚合</h3><p>数据迁移</p>
<ol>
<li>新建索引gulimall_product映射</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">PUT gulimall_product</span><br><span class="line">&#123;</span><br><span class="line">  &quot;mappings&quot;: &#123;</span><br><span class="line">    &quot;properties&quot;: &#123;</span><br><span class="line">      &quot;attrs&quot;: &#123;</span><br><span class="line">        &quot;type&quot;: &quot;nested&quot;,</span><br><span class="line">        &quot;properties&quot;: &#123;</span><br><span class="line">          &quot;attrId&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;long&quot;</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;attrName&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;keyword&quot;</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;attrValue&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;keyword&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;brandId&quot;: &#123;</span><br><span class="line">        &quot;type&quot;: &quot;long&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;brandImg&quot;: &#123;</span><br><span class="line">        &quot;type&quot;: &quot;keyword&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;brandName&quot;: &#123;</span><br><span class="line">        &quot;type&quot;: &quot;keyword&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;catalogId&quot;: &#123;</span><br><span class="line">        &quot;type&quot;: &quot;long&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;catalogName&quot;: &#123;</span><br><span class="line">        &quot;type&quot;: &quot;keyword&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;hasStock&quot;: &#123;</span><br><span class="line">        &quot;type&quot;: &quot;boolean&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;hotScore&quot;: &#123;</span><br><span class="line">        &quot;type&quot;: &quot;long&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;saleCount&quot;: &#123;</span><br><span class="line">        &quot;type&quot;: &quot;long&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;skuId&quot;: &#123;</span><br><span class="line">        &quot;type&quot;: &quot;long&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;skuImg&quot;: &#123;</span><br><span class="line">        &quot;type&quot;: &quot;keyword&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;skuPrice&quot;: &#123;</span><br><span class="line">        &quot;type&quot;: &quot;keyword&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;skuTitle&quot;: &#123;</span><br><span class="line">        &quot;type&quot;: &quot;text&quot;,</span><br><span class="line">        &quot;analyzer&quot;: &quot;ik_smart&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;spuId&quot;: &#123;</span><br><span class="line">        &quot;type&quot;: &quot;keyword&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li><p>reindex</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">POST _reindex</span><br><span class="line">&#123;</span><br><span class="line">  &quot;source&quot;: &#123;&quot;index&quot;: &quot;product&quot;&#125;,</span><br><span class="line">  &quot;dest&quot;: &#123;&quot;index&quot;: &quot;gulimall_product&quot;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<p>总DSL</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><span class="line">GET /gulimall_product/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;bool&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;must&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;skuTitle&quot;</span><span class="punctuation">:</span> <span class="string">&quot;华为&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;filter&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;term&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;hasStock&quot;</span><span class="punctuation">:</span> <span class="string">&quot;false&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;term&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;catalogId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;225&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;terms&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;brandId&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">              <span class="string">&quot;9&quot;</span><span class="punctuation">,</span></span><br><span class="line">              <span class="string">&quot;1&quot;</span></span><br><span class="line">            <span class="punctuation">]</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;range&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;skuPrice&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;gte&quot;</span><span class="punctuation">:</span> <span class="number">10</span><span class="punctuation">,</span></span><br><span class="line">              <span class="attr">&quot;lte&quot;</span><span class="punctuation">:</span> <span class="number">6500</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;nested&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;attrs&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;bool&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;filter&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                  <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;terms&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                      <span class="attr">&quot;attrs.attrId&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                        <span class="string">&quot;8&quot;</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="string">&quot;15&quot;</span></span><br><span class="line">                      <span class="punctuation">]</span></span><br><span class="line">                    <span class="punctuation">&#125;</span></span><br><span class="line">                  <span class="punctuation">&#125;</span></span><br><span class="line">                <span class="punctuation">]</span></span><br><span class="line">              <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;sort&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;skuPrice&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;order&quot;</span><span class="punctuation">:</span> <span class="string">&quot;desc&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;from&quot;</span><span class="punctuation">:</span> <span class="number">4</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;aggs&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;brand_agg&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;terms&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;field&quot;</span><span class="punctuation">:</span> <span class="string">&quot;brandId&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">10</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;aggs&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;brand_name_agg&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;terms&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;field&quot;</span><span class="punctuation">:</span> <span class="string">&quot;brandName&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">10</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;brand_img_agg&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;terms&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;field&quot;</span><span class="punctuation">:</span> <span class="string">&quot;brandImg&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">10</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;catalog_agg&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;terms&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;field&quot;</span><span class="punctuation">:</span> <span class="string">&quot;brandId&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">10</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;aggs&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;catalog_name_agg&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;terms&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;field&quot;</span><span class="punctuation">:</span> <span class="string">&quot;catalogName&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">10</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;attr_agg&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;nested&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;attrs&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;aggs&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;attr_id_agg&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;terms&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;field&quot;</span><span class="punctuation">:</span> <span class="string">&quot;attrs.attrId&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">10</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;attr_name_agg&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;terms&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;field&quot;</span><span class="punctuation">:</span> <span class="string">&quot;attrs.attrName&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">10</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;attr_value_agg&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;terms&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;field&quot;</span><span class="punctuation">:</span> <span class="string">&quot;attrs.attrValue&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">10</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="P179-SearchRequest–检索"><a href="#P179-SearchRequest–检索" class="headerlink" title="P179 SearchRequest–检索"></a>P179 SearchRequest–检索</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 准备检索请求DSL</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">private</span> SearchRequest <span class="title function_">buildSearchRequest</span><span class="params">(SearchParam param)</span> &#123;</span><br><span class="line"></span><br><span class="line">       <span class="type">SearchSourceBuilder</span> <span class="variable">builder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchSourceBuilder</span>();</span><br><span class="line">       <span class="comment">/**</span></span><br><span class="line"><span class="comment">        * 查询：模糊匹配，过滤</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">       <span class="comment">// 1. 构建bool - query</span></span><br><span class="line">       <span class="type">BoolQueryBuilder</span> <span class="variable">boolQuery</span> <span class="operator">=</span> QueryBuilders.boolQuery();</span><br><span class="line">       <span class="comment">// 1.1 must-模糊匹配</span></span><br><span class="line">       <span class="keyword">if</span> (!StringUtils.isNullOrEmpty(param.getKeyword())) &#123;</span><br><span class="line">           boolQuery.must(QueryBuilders.matchQuery(<span class="string">&quot;skuTitle&quot;</span>, param.getKeyword()));</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">// 1.2 filter</span></span><br><span class="line">       <span class="keyword">if</span> (param.getCatalog3Id() != <span class="literal">null</span>) &#123;</span><br><span class="line">           boolQuery.filter(QueryBuilders.termQuery(<span class="string">&quot;catalogId&quot;</span>, param.getCatalog3Id()));</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">if</span> (param.getBrandIds() != <span class="literal">null</span> &amp;&amp; param.getBrandIds().size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">           boolQuery.filter(QueryBuilders.termsQuery(<span class="string">&quot;brandId&quot;</span>, param.getBrandIds()));</span><br><span class="line">       &#125;</span><br><span class="line">       boolQuery.filter(QueryBuilders.termsQuery(<span class="string">&quot;hasStock&quot;</span>, param.getHasStock()==<span class="number">1</span>));</span><br><span class="line">       <span class="comment">// 按照价格区间</span></span><br><span class="line">       <span class="keyword">if</span> (!StringUtils.isNullOrEmpty(param.getSkuPrice())) &#123;</span><br><span class="line">           <span class="comment">// 1-500 / -500 / 500-</span></span><br><span class="line">           <span class="type">RangeQueryBuilder</span> <span class="variable">rangeQuery</span> <span class="operator">=</span> QueryBuilders.rangeQuery(<span class="string">&quot;skuPrice&quot;</span>);</span><br><span class="line">           String[] s = param.getSkuPrice().split(<span class="string">&quot;_&quot;</span>);</span><br><span class="line">           <span class="keyword">if</span> (param.getSkuPrice().startsWith(<span class="string">&quot;_&quot;</span>)) &#123;</span><br><span class="line">               rangeQuery.lte(s[<span class="number">1</span>]);</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">if</span> (param.getSkuPrice().endsWith(<span class="string">&quot;_&quot;</span>)) &#123;</span><br><span class="line">               rangeQuery.gte(s[<span class="number">0</span>]);</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">if</span> (s.length == <span class="number">2</span> &amp;&amp; !s[<span class="number">0</span>].equals(<span class="string">&quot;&quot;</span>)) &#123;</span><br><span class="line">               rangeQuery.gte(s[<span class="number">0</span>]).lte(s[<span class="number">1</span>]);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">// 按指定的属性进行查询</span></span><br><span class="line">       <span class="keyword">if</span> (param.getAttrs() != <span class="literal">null</span> &amp;&amp; param.getAttrs().size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">           <span class="keyword">for</span> (String attr: param.getAttrs()) &#123;</span><br><span class="line">               <span class="comment">// attrs=1_6.1寸:6.7寸&amp;attrs=2_16G:8G</span></span><br><span class="line">               String[] s = attr.split(<span class="string">&quot;_&quot;</span>);</span><br><span class="line">               <span class="type">String</span> <span class="variable">attrId</span> <span class="operator">=</span> s[<span class="number">0</span>];</span><br><span class="line">               String[] attrValues = s[<span class="number">1</span>].split(<span class="string">&quot;:&quot;</span>);</span><br><span class="line">               <span class="type">BoolQueryBuilder</span> <span class="variable">nestedBoolQuery</span> <span class="operator">=</span> QueryBuilders.boolQuery();</span><br><span class="line">               nestedBoolQuery.must(QueryBuilders.termQuery(<span class="string">&quot;attrs.attrId&quot;</span>, attrId));</span><br><span class="line">               nestedBoolQuery.must(QueryBuilders.termsQuery(<span class="string">&quot;attrs.attrId&quot;</span>, attrValues));</span><br><span class="line">               <span class="type">NestedQueryBuilder</span> <span class="variable">nestedQueryBuilder</span> <span class="operator">=</span> QueryBuilders.nestedQuery(<span class="string">&quot;attrs&quot;</span>, nestedBoolQuery, ScoreMode.None);</span><br><span class="line">               boolQuery.filter(nestedQueryBuilder);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">// 添加查询</span></span><br><span class="line">       builder.query(boolQuery);</span><br><span class="line">       <span class="comment">/**</span></span><br><span class="line"><span class="comment">        * 排序，分页，高亮</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line"></span><br><span class="line">       <span class="comment">/**</span></span><br><span class="line"><span class="comment">        * 聚合分析</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line"></span><br><span class="line">       <span class="type">SearchRequest</span> <span class="variable">searchRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchRequest</span>(<span class="keyword">new</span> <span class="title class_">String</span>[]&#123;EsConstant.PRODUCT_INDEX&#125;, builder);</span><br><span class="line"></span><br><span class="line">       <span class="keyword">return</span> searchRequest;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<h3 id="P180-测试查询DSL"><a href="#P180-测试查询DSL" class="headerlink" title="P180 测试查询DSL"></a>P180 测试查询DSL</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line">GET gulimall_product/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">	<span class="attr">&quot;from&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">	<span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">	<span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">		<span class="attr">&quot;bool&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">			<span class="attr">&quot;must&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">&#123;</span></span><br><span class="line">				<span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">					<span class="attr">&quot;skuTitle&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">						<span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="string">&quot;华为&quot;</span><span class="punctuation">,</span></span><br><span class="line">						<span class="attr">&quot;operator&quot;</span><span class="punctuation">:</span> <span class="string">&quot;OR&quot;</span><span class="punctuation">,</span></span><br><span class="line">						<span class="attr">&quot;prefix_length&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">						<span class="attr">&quot;max_expansions&quot;</span><span class="punctuation">:</span> <span class="number">50</span><span class="punctuation">,</span></span><br><span class="line">						<span class="attr">&quot;fuzzy_transpositions&quot;</span><span class="punctuation">:</span> <span class="keyword">true</span><span class="punctuation">,</span></span><br><span class="line">						<span class="attr">&quot;lenient&quot;</span><span class="punctuation">:</span> <span class="keyword">false</span><span class="punctuation">,</span></span><br><span class="line">						<span class="attr">&quot;zero_terms_query&quot;</span><span class="punctuation">:</span> <span class="string">&quot;NONE&quot;</span><span class="punctuation">,</span></span><br><span class="line">						<span class="attr">&quot;auto_generate_synonyms_phrase_query&quot;</span><span class="punctuation">:</span> <span class="keyword">true</span><span class="punctuation">,</span></span><br><span class="line">						<span class="attr">&quot;boost&quot;</span><span class="punctuation">:</span> <span class="number">1.0</span></span><br><span class="line">					<span class="punctuation">&#125;</span></span><br><span class="line">				<span class="punctuation">&#125;</span></span><br><span class="line">			<span class="punctuation">&#125;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">			<span class="attr">&quot;filter&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">&#123;</span></span><br><span class="line">				<span class="attr">&quot;term&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">					<span class="attr">&quot;catalogId&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">						<span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="number">225</span><span class="punctuation">,</span></span><br><span class="line">						<span class="attr">&quot;boost&quot;</span><span class="punctuation">:</span> <span class="number">1.0</span></span><br><span class="line">					<span class="punctuation">&#125;</span></span><br><span class="line">				<span class="punctuation">&#125;</span></span><br><span class="line">			<span class="punctuation">&#125;</span><span class="punctuation">,</span> <span class="punctuation">&#123;</span></span><br><span class="line">				<span class="attr">&quot;terms&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">					<span class="attr">&quot;hasStock&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="keyword">true</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">					<span class="attr">&quot;boost&quot;</span><span class="punctuation">:</span> <span class="number">1.0</span></span><br><span class="line">				<span class="punctuation">&#125;</span></span><br><span class="line">			<span class="punctuation">&#125;</span><span class="punctuation">,</span> <span class="punctuation">&#123;</span></span><br><span class="line">				<span class="attr">&quot;nested&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">					<span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">						<span class="attr">&quot;bool&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">							<span class="attr">&quot;must&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">&#123;</span></span><br><span class="line">								<span class="attr">&quot;term&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">									<span class="attr">&quot;attrs.attrId&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">										<span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="string">&quot;15&quot;</span><span class="punctuation">,</span></span><br><span class="line">										<span class="attr">&quot;boost&quot;</span><span class="punctuation">:</span> <span class="number">1.0</span></span><br><span class="line">									<span class="punctuation">&#125;</span></span><br><span class="line">								<span class="punctuation">&#125;</span></span><br><span class="line">							<span class="punctuation">&#125;</span><span class="punctuation">,</span> <span class="punctuation">&#123;</span></span><br><span class="line">								<span class="attr">&quot;terms&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">									<span class="attr">&quot;attrs.attrValue&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;高通(Qualcomm)&quot;</span><span class="punctuation">,</span> <span class="string">&quot;xxx&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">									<span class="attr">&quot;boost&quot;</span><span class="punctuation">:</span> <span class="number">1.0</span></span><br><span class="line">								<span class="punctuation">&#125;</span></span><br><span class="line">							<span class="punctuation">&#125;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">							<span class="attr">&quot;adjust_pure_negative&quot;</span><span class="punctuation">:</span> <span class="keyword">true</span><span class="punctuation">,</span></span><br><span class="line">							<span class="attr">&quot;boost&quot;</span><span class="punctuation">:</span> <span class="number">1.0</span></span><br><span class="line">						<span class="punctuation">&#125;</span></span><br><span class="line">					<span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">					<span class="attr">&quot;path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;attrs&quot;</span><span class="punctuation">,</span></span><br><span class="line">					<span class="attr">&quot;ignore_unmapped&quot;</span><span class="punctuation">:</span> <span class="keyword">false</span><span class="punctuation">,</span></span><br><span class="line">					<span class="attr">&quot;score_mode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;none&quot;</span><span class="punctuation">,</span></span><br><span class="line">					<span class="attr">&quot;boost&quot;</span><span class="punctuation">:</span> <span class="number">1.0</span></span><br><span class="line">				<span class="punctuation">&#125;</span></span><br><span class="line">			<span class="punctuation">&#125;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">			<span class="attr">&quot;adjust_pure_negative&quot;</span><span class="punctuation">:</span> <span class="keyword">true</span><span class="punctuation">,</span></span><br><span class="line">			<span class="attr">&quot;boost&quot;</span><span class="punctuation">:</span> <span class="number">1.0</span></span><br><span class="line">		<span class="punctuation">&#125;</span></span><br><span class="line">	<span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">	<span class="attr">&quot;sort&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">&#123;</span></span><br><span class="line">		<span class="attr">&quot;skuPrice&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">			<span class="attr">&quot;order&quot;</span><span class="punctuation">:</span> <span class="string">&quot;desc&quot;</span></span><br><span class="line">		<span class="punctuation">&#125;</span></span><br><span class="line">	<span class="punctuation">&#125;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">	<span class="attr">&quot;highlight&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">		<span class="attr">&quot;pre_tags&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;&lt;b style=&#x27;color:red&#x27;&gt;&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">		<span class="attr">&quot;post_tags&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;&lt;/b&gt;&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">		<span class="attr">&quot;fields&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">			<span class="attr">&quot;skuTitle&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line">		<span class="punctuation">&#125;</span></span><br><span class="line">	<span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="P181-测试聚合DSL"><a href="#P181-测试聚合DSL" class="headerlink" title="P181 测试聚合DSL"></a>P181 测试聚合DSL</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 准备检索请求DSL</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> SearchRequest <span class="title function_">buildSearchRequest</span><span class="params">(SearchParam param)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">SearchSourceBuilder</span> <span class="variable">builder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchSourceBuilder</span>();</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 查询：模糊匹配，过滤</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="comment">// 1. 构建bool - query</span></span><br><span class="line">        <span class="type">BoolQueryBuilder</span> <span class="variable">boolQuery</span> <span class="operator">=</span> QueryBuilders.boolQuery();</span><br><span class="line">        <span class="comment">// 1.1 must-模糊匹配</span></span><br><span class="line">        <span class="keyword">if</span> (!StringUtils.isNullOrEmpty(param.getKeyword())) &#123;</span><br><span class="line">            boolQuery.must(QueryBuilders.matchQuery(<span class="string">&quot;skuTitle&quot;</span>, param.getKeyword()));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 1.2 filter</span></span><br><span class="line">        <span class="keyword">if</span> (param.getCatalog3Id() != <span class="literal">null</span>) &#123;</span><br><span class="line">            boolQuery.filter(QueryBuilders.termQuery(<span class="string">&quot;catalogId&quot;</span>, param.getCatalog3Id()));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (param.getBrandIds() != <span class="literal">null</span> &amp;&amp; param.getBrandIds().size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            boolQuery.filter(QueryBuilders.termsQuery(<span class="string">&quot;brandId&quot;</span>, param.getBrandIds()));</span><br><span class="line">        &#125;</span><br><span class="line">        boolQuery.filter(QueryBuilders.termsQuery(<span class="string">&quot;hasStock&quot;</span>, param.getHasStock()==<span class="number">1</span>));</span><br><span class="line">        <span class="comment">// 按照价格区间</span></span><br><span class="line">        <span class="keyword">if</span> (!StringUtils.isNullOrEmpty(param.getSkuPrice())) &#123;</span><br><span class="line">            <span class="comment">// 1-500 / -500 / 500-</span></span><br><span class="line">            <span class="type">RangeQueryBuilder</span> <span class="variable">rangeQuery</span> <span class="operator">=</span> QueryBuilders.rangeQuery(<span class="string">&quot;skuPrice&quot;</span>);</span><br><span class="line">            String[] s = param.getSkuPrice().split(<span class="string">&quot;_&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (param.getSkuPrice().startsWith(<span class="string">&quot;_&quot;</span>)) &#123;</span><br><span class="line">                rangeQuery.lte(s[<span class="number">1</span>]);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (param.getSkuPrice().endsWith(<span class="string">&quot;_&quot;</span>)) &#123;</span><br><span class="line">                rangeQuery.gte(s[<span class="number">0</span>]);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (s.length == <span class="number">2</span> &amp;&amp; !s[<span class="number">0</span>].equals(<span class="string">&quot;&quot;</span>)) &#123;</span><br><span class="line">                rangeQuery.gte(s[<span class="number">0</span>]).lte(s[<span class="number">1</span>]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 按指定的属性进行查询</span></span><br><span class="line">        <span class="keyword">if</span> (param.getAttrs() != <span class="literal">null</span> &amp;&amp; param.getAttrs().size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (String attr: param.getAttrs()) &#123;</span><br><span class="line">                <span class="comment">// attrs=1_6.1寸:6.7寸&amp;attrs=2_16G:8G</span></span><br><span class="line">                String[] s = attr.split(<span class="string">&quot;_&quot;</span>);</span><br><span class="line">                <span class="type">String</span> <span class="variable">attrId</span> <span class="operator">=</span> s[<span class="number">0</span>];</span><br><span class="line">                String[] attrValues = s[<span class="number">1</span>].split(<span class="string">&quot;:&quot;</span>);</span><br><span class="line">                <span class="type">BoolQueryBuilder</span> <span class="variable">nestedBoolQuery</span> <span class="operator">=</span> QueryBuilders.boolQuery();</span><br><span class="line">                nestedBoolQuery.must(QueryBuilders.termQuery(<span class="string">&quot;attrs.attrId&quot;</span>, attrId));</span><br><span class="line">                nestedBoolQuery.must(QueryBuilders.termsQuery(<span class="string">&quot;attrs.attrValue&quot;</span>, attrValues));</span><br><span class="line">                <span class="type">NestedQueryBuilder</span> <span class="variable">nestedQueryBuilder</span> <span class="operator">=</span> QueryBuilders.nestedQuery(<span class="string">&quot;attrs&quot;</span>, nestedBoolQuery, ScoreMode.None);</span><br><span class="line">                boolQuery.filter(nestedQueryBuilder);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 添加查询</span></span><br><span class="line">        builder.query(boolQuery);</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 排序，分页，高亮</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="comment">// 2.1 排序</span></span><br><span class="line">        <span class="keyword">if</span> (!StringUtils.isNullOrEmpty(param.getSort())) &#123;</span><br><span class="line">            <span class="comment">// sort=hotScore_asc/desc</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">sort</span> <span class="operator">=</span> param.getSort();</span><br><span class="line">            String[] s = sort.split(<span class="string">&quot;_&quot;</span>);</span><br><span class="line">            builder.sort(s[<span class="number">0</span>], SortOrder.fromString(s[<span class="number">1</span>]));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 2.2 分页</span></span><br><span class="line">        <span class="comment">// pageSize=5</span></span><br><span class="line">        <span class="comment">// pageNum=1, from:0, size=5</span></span><br><span class="line">        <span class="comment">// pageNum=2, from:5, size=5</span></span><br><span class="line">        <span class="comment">// from = (pageNum - 1) * size</span></span><br><span class="line">        builder.from((param.getPageNum()-<span class="number">1</span>)*EsConstant.PRODUCT_PAGESIZE);</span><br><span class="line">        builder.size(EsConstant.PRODUCT_PAGESIZE);</span><br><span class="line">        <span class="comment">// 2.3 高亮</span></span><br><span class="line">        <span class="keyword">if</span> (!StringUtils.isNullOrEmpty(param.getKeyword())) &#123;</span><br><span class="line">            <span class="type">HighlightBuilder</span> <span class="variable">highlightBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HighlightBuilder</span>();</span><br><span class="line">            highlightBuilder.field(<span class="string">&quot;skuTitle&quot;</span>);</span><br><span class="line">            highlightBuilder.preTags(<span class="string">&quot;&lt;b style=&#x27;color:red&#x27;&gt;&quot;</span>);</span><br><span class="line">            highlightBuilder.postTags(<span class="string">&quot;&lt;/b&gt;&quot;</span>);</span><br><span class="line">            builder.highlighter(highlightBuilder);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 测试查询DSL</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line"><span class="comment">//        String s = builder.toString();</span></span><br><span class="line"><span class="comment">//        System.out.println(&quot;构建的查询DSL&quot; + s);</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 聚合分析</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="comment">// 3.1 品牌聚合</span></span><br><span class="line">        <span class="type">TermsAggregationBuilder</span> <span class="variable">brand_agg</span> <span class="operator">=</span> AggregationBuilders.terms(<span class="string">&quot;brand_agg&quot;</span>);</span><br><span class="line">        brand_agg.field(<span class="string">&quot;brandId&quot;</span>).size(<span class="number">50</span>);</span><br><span class="line">        <span class="comment">// 品牌聚合的子聚合</span></span><br><span class="line">        brand_agg.subAggregation(AggregationBuilders.terms(<span class="string">&quot;brand_name_agg&quot;</span>).field(<span class="string">&quot;brandName&quot;</span>).size(<span class="number">1</span>));</span><br><span class="line">        brand_agg.subAggregation(AggregationBuilders.terms(<span class="string">&quot;brand_img_agg&quot;</span>).field(<span class="string">&quot;brandImg&quot;</span>).size(<span class="number">1</span>));</span><br><span class="line">        builder.aggregation(brand_agg);</span><br><span class="line">        <span class="comment">// 3.2 分类聚合</span></span><br><span class="line">        <span class="type">TermsAggregationBuilder</span> <span class="variable">catalog_agg</span> <span class="operator">=</span> AggregationBuilders.terms(<span class="string">&quot;catalog_agg&quot;</span>);</span><br><span class="line">        catalog_agg.field(<span class="string">&quot;catalogId&quot;</span>).size(<span class="number">50</span>);</span><br><span class="line">        <span class="comment">// 分类聚合的子聚合</span></span><br><span class="line">        catalog_agg.subAggregation(AggregationBuilders.terms(<span class="string">&quot;catalog_name_agg&quot;</span>).field(<span class="string">&quot;catalogName&quot;</span>).size(<span class="number">1</span>));</span><br><span class="line">        builder.aggregation(catalog_agg);</span><br><span class="line">        <span class="comment">// 3.3 属性聚合</span></span><br><span class="line">        <span class="type">NestedAggregationBuilder</span> <span class="variable">attr_nested</span> <span class="operator">=</span> AggregationBuilders.nested(<span class="string">&quot;attr_agg&quot;</span>, <span class="string">&quot;attrs&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">TermsAggregationBuilder</span> <span class="variable">attr_id_agg</span> <span class="operator">=</span> AggregationBuilders.terms(<span class="string">&quot;attr_id_agg&quot;</span>).field(<span class="string">&quot;attrs.attrId&quot;</span>).size(<span class="number">50</span>);</span><br><span class="line">        <span class="comment">// 属性聚合的子聚合</span></span><br><span class="line">        attr_id_agg.subAggregation(AggregationBuilders.terms(<span class="string">&quot;attr_name_agg&quot;</span>).field(<span class="string">&quot;attrs.attrName&quot;</span>).size(<span class="number">1</span>));</span><br><span class="line">        attr_id_agg.subAggregation(AggregationBuilders.terms(<span class="string">&quot;attr_value_agg&quot;</span>).field(<span class="string">&quot;attrs.attrValue&quot;</span>).size(<span class="number">1</span>));</span><br><span class="line">        attr_nested.subAggregation(attr_id_agg);</span><br><span class="line">        builder.aggregation(attr_nested);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 测试聚合DSL</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> builder.toString();</span><br><span class="line">        System.out.println(<span class="string">&quot;构建的查询DSL&quot;</span> + s);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="type">SearchRequest</span> <span class="variable">searchRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchRequest</span>(<span class="keyword">new</span> <span class="title class_">String</span>[]&#123;EsConstant.PRODUCT_INDEX&#125;, builder);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> searchRequest;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>P182 检索服务–SearchResult 封装</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> SearchResult <span class="title function_">buildSearchResult</span><span class="params">(SearchResponse response, SearchParam param)</span> &#123;</span><br><span class="line"></span><br><span class="line">       <span class="type">SearchResult</span> <span class="variable">result</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchResult</span>();</span><br><span class="line">       <span class="comment">// 1. 返回所有查询到的商品</span></span><br><span class="line">       <span class="type">SearchHits</span> <span class="variable">hits</span> <span class="operator">=</span> response.getHits();</span><br><span class="line"></span><br><span class="line">       List&lt;SkuEsModel&gt; esModels = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">       <span class="keyword">if</span> (hits.getHits() != <span class="literal">null</span> &amp;&amp; hits.getHits().length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">           <span class="keyword">for</span> (SearchHit hit : hits) &#123;</span><br><span class="line">               <span class="type">String</span> <span class="variable">sourceAsString</span> <span class="operator">=</span> hit.getSourceAsString();</span><br><span class="line">               <span class="type">SkuEsModel</span> <span class="variable">esModel</span> <span class="operator">=</span> JSON.parseObject(sourceAsString, SkuEsModel.class);</span><br><span class="line">               <span class="comment">//判断是否按关键字检索，若是就显示高亮，否则不显示</span></span><br><span class="line">               <span class="keyword">if</span> (!StringUtils.isNullOrEmpty(param.getKeyword())) &#123;</span><br><span class="line">                   <span class="comment">//拿到高亮信息显示标题</span></span><br><span class="line">                   <span class="type">HighlightField</span> <span class="variable">skuTitle</span> <span class="operator">=</span> hit.getHighlightFields().get(<span class="string">&quot;skuTitle&quot;</span>);</span><br><span class="line">                   <span class="type">String</span> <span class="variable">skuTitleValue</span> <span class="operator">=</span> skuTitle.getFragments()[<span class="number">0</span>].string();</span><br><span class="line">                   esModel.setSkuTitle(skuTitleValue);</span><br><span class="line">               &#125;</span><br><span class="line">               esModels.add(esModel);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">// 2. 当前所有商品涉及到的所有属性信息</span></span><br><span class="line">       List&lt;SearchResult.AttrVo&gt; attrVos = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">       <span class="type">ParsedNested</span> <span class="variable">attrsAgg</span> <span class="operator">=</span> response.getAggregations().get(<span class="string">&quot;attr_agg&quot;</span>);</span><br><span class="line">       <span class="type">ParsedLongTerms</span> <span class="variable">attrIdAgg</span> <span class="operator">=</span> attrsAgg.getAggregations().get(<span class="string">&quot;attr_id_agg&quot;</span>);</span><br><span class="line">       <span class="keyword">for</span> (Terms.Bucket bucket : attrIdAgg.getBuckets()) &#123;</span><br><span class="line">           SearchResult.<span class="type">AttrVo</span> <span class="variable">attrVo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchResult</span>.AttrVo();</span><br><span class="line">           <span class="comment">//1、得到属性的id</span></span><br><span class="line">           <span class="type">long</span> <span class="variable">attrId</span> <span class="operator">=</span> bucket.getKeyAsNumber().longValue();</span><br><span class="line">           attrVo.setAttrId(attrId);</span><br><span class="line"></span><br><span class="line">           <span class="comment">//2、得到属性的名字</span></span><br><span class="line">           <span class="type">ParsedStringTerms</span> <span class="variable">attrNameAgg</span> <span class="operator">=</span> bucket.getAggregations().get(<span class="string">&quot;attr_name_agg&quot;</span>);</span><br><span class="line">           <span class="type">String</span> <span class="variable">attrName</span> <span class="operator">=</span> attrNameAgg.getBuckets().get(<span class="number">0</span>).getKeyAsString();</span><br><span class="line">           attrVo.setAttrName(attrName);</span><br><span class="line"></span><br><span class="line">           <span class="comment">//3、得到属性的所有值</span></span><br><span class="line">           <span class="type">ParsedStringTerms</span> <span class="variable">attrValueAgg</span> <span class="operator">=</span> bucket.getAggregations().get(<span class="string">&quot;attr_value_agg&quot;</span>);</span><br><span class="line">           List&lt;String&gt; attrValues = attrValueAgg.getBuckets().stream().map(item -&gt; item.getKeyAsString()).collect(Collectors.toList());</span><br><span class="line">           attrVo.setAttrValue(attrValues);</span><br><span class="line"></span><br><span class="line">           attrVos.add(attrVo);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       result.setAttrs(attrVos);</span><br><span class="line">       <span class="comment">// 3. 当前所有商品涉及到的所有品牌信息</span></span><br><span class="line">       List&lt;SearchResult.BrandVo&gt; brandVos = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">       <span class="comment">//获取到品牌的聚合</span></span><br><span class="line">       <span class="type">ParsedLongTerms</span> <span class="variable">brandAgg</span> <span class="operator">=</span> response.getAggregations().get(<span class="string">&quot;brand_agg&quot;</span>);</span><br><span class="line">       <span class="keyword">for</span> (Terms.Bucket bucket : brandAgg.getBuckets()) &#123;</span><br><span class="line">           SearchResult.<span class="type">BrandVo</span> <span class="variable">brandVo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchResult</span>.BrandVo();</span><br><span class="line"></span><br><span class="line">           <span class="comment">//1、得到品牌的id</span></span><br><span class="line">           <span class="type">long</span> <span class="variable">brandId</span> <span class="operator">=</span> bucket.getKeyAsNumber().longValue();</span><br><span class="line">           brandVo.setBrandId(brandId);</span><br><span class="line"></span><br><span class="line">           <span class="comment">//2、得到品牌的名字</span></span><br><span class="line">           <span class="type">ParsedStringTerms</span> <span class="variable">brandNameAgg</span> <span class="operator">=</span> bucket.getAggregations().get(<span class="string">&quot;brand_name_agg&quot;</span>);</span><br><span class="line">           <span class="type">String</span> <span class="variable">brandName</span> <span class="operator">=</span> brandNameAgg.getBuckets().get(<span class="number">0</span>).getKeyAsString();</span><br><span class="line">           brandVo.setBrandName(brandName);</span><br><span class="line"></span><br><span class="line">           <span class="comment">//3、得到品牌的图片</span></span><br><span class="line">           <span class="type">ParsedStringTerms</span> <span class="variable">brandImgAgg</span> <span class="operator">=</span> bucket.getAggregations().get(<span class="string">&quot;brand_img_agg&quot;</span>);</span><br><span class="line">           <span class="type">String</span> <span class="variable">brandImg</span> <span class="operator">=</span> brandImgAgg.getBuckets().get(<span class="number">0</span>).getKeyAsString();</span><br><span class="line">           brandVo.setBrandImg(brandImg);</span><br><span class="line"></span><br><span class="line">           brandVos.add(brandVo);</span><br><span class="line">       &#125;</span><br><span class="line">       result.setBrands(brandVos);</span><br><span class="line">       </span><br><span class="line">       <span class="comment">// 4. 当前所有商品涉及到的所有分类信息</span></span><br><span class="line">       <span class="comment">//获取到分类的聚合</span></span><br><span class="line">       List&lt;SearchResult.CatalogVo&gt; catalogVos = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">       <span class="type">ParsedLongTerms</span> <span class="variable">catalogAgg</span> <span class="operator">=</span> response.getAggregations().get(<span class="string">&quot;catalog_agg&quot;</span>);</span><br><span class="line">       <span class="keyword">for</span> (Terms.Bucket bucket : catalogAgg.getBuckets()) &#123;</span><br><span class="line">           SearchResult.<span class="type">CatalogVo</span> <span class="variable">catalogVo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchResult</span>.CatalogVo();</span><br><span class="line">           <span class="comment">//得到分类id</span></span><br><span class="line">           <span class="type">String</span> <span class="variable">keyAsString</span> <span class="operator">=</span> bucket.getKeyAsString();</span><br><span class="line">           catalogVo.setCatalogId(Long.parseLong(keyAsString));</span><br><span class="line"></span><br><span class="line">           <span class="comment">//得到分类名</span></span><br><span class="line">           <span class="type">ParsedStringTerms</span> <span class="variable">catalogNameAgg</span> <span class="operator">=</span> bucket.getAggregations().get(<span class="string">&quot;catalog_name_agg&quot;</span>);</span><br><span class="line">           <span class="type">String</span> <span class="variable">catalogName</span> <span class="operator">=</span> catalogNameAgg.getBuckets().get(<span class="number">0</span>).getKeyAsString();</span><br><span class="line">           catalogVo.setCatalogName(catalogName);</span><br><span class="line">           catalogVos.add(catalogVo);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       result.setCatalogs(catalogVos);</span><br><span class="line"></span><br><span class="line">       <span class="comment">// 5. 分页信息</span></span><br><span class="line">       <span class="comment">// 5.1 页码</span></span><br><span class="line">       result.setPageNum(param.getPageNum());</span><br><span class="line">       <span class="comment">// 5.2 总记录数</span></span><br><span class="line">       <span class="type">int</span> <span class="variable">total</span> <span class="operator">=</span> (<span class="type">int</span>) hits.getTotalHits().value;</span><br><span class="line">       result.setTotal((<span class="type">long</span>) total);</span><br><span class="line">       <span class="comment">// 5.3 总页码</span></span><br><span class="line">       <span class="type">int</span> <span class="variable">totalPages</span> <span class="operator">=</span> total % EsConstant.PRODUCT_PAGESIZE == <span class="number">0</span> ?</span><br><span class="line">               total / EsConstant.PRODUCT_PAGESIZE :</span><br><span class="line">               total / EsConstant.PRODUCT_PAGESIZE + <span class="number">1</span>;</span><br><span class="line">       result.setTotalPages(totalPages);</span><br><span class="line">       <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<h3 id="P182-183-调试-amp-高亮"><a href="#P182-183-调试-amp-高亮" class="headerlink" title="P182-183 调试&amp;高亮"></a>P182-183 调试&amp;高亮</h3><h3 id="P184-页面基本数据渲染"><a href="#P184-页面基本数据渲染" class="headerlink" title="P184 页面基本数据渲染"></a>P184 页面基本数据渲染</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;rig_tab&quot;</span>&gt;</span></span><br><span class="line">                   <span class="tag">&lt;<span class="name">div</span> <span class="attr">th:each</span>=<span class="string">&quot;product : $&#123;result.getProduct()&#125;&quot;</span>&gt;</span></span><br><span class="line">                       <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;ico&quot;</span>&gt;</span></span><br><span class="line">                           <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;iconfont icon-weiguanzhu&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line">                           <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;/static/search/#&quot;</span>&gt;</span>关注<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                       <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                       <span class="tag">&lt;<span class="name">p</span> <span class="attr">class</span>=<span class="string">&quot;da&quot;</span>&gt;</span></span><br><span class="line">                           <span class="tag">&lt;<span class="name">a</span> <span class="attr">th:href</span>=<span class="string">&quot;|http://item.gulimall.com/$&#123;product.skuId&#125;.html|&quot;</span> &gt;</span></span><br><span class="line">                               <span class="tag">&lt;<span class="name">img</span>   <span class="attr">class</span>=<span class="string">&quot;dim&quot;</span> <span class="attr">th:src</span>=<span class="string">&quot;$&#123;product.skuImg&#125;&quot;</span>&gt;</span></span><br><span class="line">                           <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                       <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">                       <span class="tag">&lt;<span class="name">ul</span> <span class="attr">class</span>=<span class="string">&quot;tab_im&quot;</span>&gt;</span></span><br><span class="line">                           <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;/static/search/#&quot;</span> <span class="attr">title</span>=<span class="string">&quot;黑色&quot;</span>&gt;</span></span><br><span class="line">                               <span class="tag">&lt;<span class="name">img</span> <span class="attr">th:src</span>=<span class="string">&quot;$&#123;product.skuImg&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                       <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">                       <span class="tag">&lt;<span class="name">p</span> <span class="attr">class</span>=<span class="string">&quot;tab_R&quot;</span>&gt;</span></span><br><span class="line">                           <span class="tag">&lt;<span class="name">span</span> <span class="attr">th:text</span>=<span class="string">&quot;&#x27;￥&#x27; + $&#123;product.skuPrice&#125;&quot;</span>&gt;</span>¥5199.00<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                       <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">                       <span class="tag">&lt;<span class="name">p</span> <span class="attr">class</span>=<span class="string">&quot;tab_JE&quot;</span>&gt;</span></span><br><span class="line">                           <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;/static/search/#&quot;</span> <span class="attr">th:utext</span>=<span class="string">&quot;$&#123;product.skuTitle&#125;&quot;</span>&gt;</span></span><br><span class="line">                               Apple iPhone 7 Plus (A1661) 32G 黑色 移动联通电信4G手机</span><br><span class="line">                           <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                       <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">                       <span class="tag">&lt;<span class="name">p</span> <span class="attr">class</span>=<span class="string">&quot;tab_PI&quot;</span>&gt;</span>已有<span class="tag">&lt;<span class="name">span</span>&gt;</span>11万+<span class="tag">&lt;/<span class="name">span</span>&gt;</span>热门评价</span><br><span class="line">                           <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;/static/search/#&quot;</span>&gt;</span>二手有售<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                       <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">                       <span class="tag">&lt;<span class="name">p</span> <span class="attr">class</span>=<span class="string">&quot;tab_CP&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;/static/search/#&quot;</span> <span class="attr">title</span>=<span class="string">&quot;谷粒商城Apple产品专营店&quot;</span>&gt;</span>谷粒商城Apple产品...<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                           <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&#x27;#&#x27;</span> <span class="attr">title</span>=<span class="string">&quot;联系供应商进行咨询&quot;</span>&gt;</span></span><br><span class="line">                               <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;/static/search/img/xcxc.png&quot;</span>&gt;</span></span><br><span class="line">                           <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                       <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">                       <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;tab_FO&quot;</span>&gt;</span></span><br><span class="line">                           <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;FO_one&quot;</span>&gt;</span></span><br><span class="line">                               <span class="tag">&lt;<span class="name">p</span>&gt;</span>自营</span><br><span class="line">                                   <span class="tag">&lt;<span class="name">span</span>&gt;</span>谷粒商城自营,品质保证<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                               <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">                               <span class="tag">&lt;<span class="name">p</span>&gt;</span>满赠</span><br><span class="line">                                   <span class="tag">&lt;<span class="name">span</span>&gt;</span>该商品参加满赠活动<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                               <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">                           <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                       <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                   <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="P185-页面筛选条件渲染"><a href="#P185-页面筛选条件渲染" class="headerlink" title="P185 页面筛选条件渲染"></a>P185 页面筛选条件渲染</h3><h3 id="P186-页面分页数据渲染"><a href="#P186-页面分页数据渲染" class="headerlink" title="P186 页面分页数据渲染"></a>P186 页面分页数据渲染</h3><h3 id="P187-页面排序"><a href="#P187-页面排序" class="headerlink" title="P187 页面排序"></a>P187 页面排序</h3><h3 id="P188-页面排序字段回显"><a href="#P188-页面排序字段回显" class="headerlink" title="P188 页面排序字段回显"></a>P188 页面排序字段回显</h3><h3 id="P189-页面价格区间"><a href="#P189-页面价格区间" class="headerlink" title="P189 页面价格区间"></a>P189 页面价格区间</h3><h3 id="P190-面包屑导航"><a href="#P190-面包屑导航" class="headerlink" title="P190 面包屑导航"></a>P190 面包屑导航</h3><ol>
<li>gulimall-search 添加feign依赖</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-cloud-starter-openfeign&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>开启远程调用@EnableFeignClients</li>
<li>创建接口ProductFeignService， 加入注解@FeignClient(“gulimall-product”)</li>
</ol>
<h3 id="P191-条件删除与URL编码问题"><a href="#P191-条件删除与URL编码问题" class="headerlink" title="P191 条件删除与URL编码问题"></a>P191 条件删除与URL编码问题</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 6. 构建面包屑导航功能</span></span><br><span class="line">      <span class="keyword">if</span> (param.getAttrs() != <span class="literal">null</span> &amp;&amp; param.getAttrs().size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">          List&lt;SearchResult.NavVo&gt; collect = param.getAttrs().stream().map(attr -&gt; &#123;</span><br><span class="line">              <span class="comment">//1、分析每一个attrs传过来的参数值</span></span><br><span class="line">              SearchResult.<span class="type">NavVo</span> <span class="variable">navVo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchResult</span>.NavVo();</span><br><span class="line">              String[] s = attr.split(<span class="string">&quot;_&quot;</span>);</span><br><span class="line">              navVo.setNavValue(s[<span class="number">1</span>]);</span><br><span class="line">              <span class="type">R</span> <span class="variable">r</span> <span class="operator">=</span> productFeignService.attrInfo(Long.parseLong(s[<span class="number">0</span>]));</span><br><span class="line">              <span class="keyword">if</span> (r.getCode() == <span class="number">0</span>) &#123;</span><br><span class="line">                  <span class="type">AttrResponseVo</span> <span class="variable">data</span> <span class="operator">=</span> r.getData(<span class="string">&quot;attr&quot;</span>, <span class="keyword">new</span> <span class="title class_">TypeReference</span>&lt;AttrResponseVo&gt;() &#123;</span><br><span class="line">                  &#125;);</span><br><span class="line">                  navVo.setNavName(data.getAttrName());</span><br><span class="line">              &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                  navVo.setNavName(s[<span class="number">0</span>]);</span><br><span class="line">              &#125;</span><br><span class="line"></span><br><span class="line">              <span class="comment">//2、取消了这个面包屑以后，我们要跳转到哪个地方，将请求的地址url里面的当前置空</span></span><br><span class="line">              <span class="comment">//拿到所有的查询条件，去掉当前</span></span><br><span class="line">              <span class="type">String</span> <span class="variable">encode</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">              <span class="keyword">try</span> &#123;</span><br><span class="line">                  encode = URLEncoder.encode(attr,<span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">                  encode = encode.replace(<span class="string">&quot;+&quot;</span>,<span class="string">&quot;%20&quot;</span>);  <span class="comment">//浏览器对空格的编码和Java不一样，差异化处理</span></span><br><span class="line">                  encode = encode.replace(<span class="string">&quot;%28&quot;</span>,<span class="string">&quot;(&quot;</span>);  <span class="comment">//浏览器对空格的编码和Java不一样，差异化处理</span></span><br><span class="line">                  encode = encode.replace(<span class="string">&quot;%29&quot;</span>,<span class="string">&quot;)&quot;</span>);  <span class="comment">//浏览器对空格的编码和Java不一样，差异化处理</span></span><br><span class="line">              &#125; <span class="keyword">catch</span> (UnsupportedEncodingException e) &#123;</span><br><span class="line">                  e.printStackTrace();</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="type">String</span> <span class="variable">replace</span> <span class="operator">=</span> param.get_queryString().replace(<span class="string">&quot;&amp;attrs=&quot;</span> + encode, <span class="string">&quot;&quot;</span>);</span><br><span class="line">              navVo.setLink(<span class="string">&quot;http://search.gulimall.com:8081/list.html?&quot;</span> + replace);</span><br><span class="line"></span><br><span class="line">              <span class="keyword">return</span> navVo;</span><br><span class="line">          &#125;).collect(Collectors.toList());</span><br><span class="line"></span><br><span class="line">          result.setNavs(collect);</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure>

<h3 id="P192-条件筛选联动"><a href="#P192-条件筛选联动" class="headerlink" title="P192 条件筛选联动"></a>P192 条件筛选联动</h3><p>品牌分类加入面包屑</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 品牌，分类</span></span><br><span class="line">      <span class="keyword">if</span> (param.getBrandIds() != <span class="literal">null</span> &amp;&amp; param.getBrandIds().size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">          List&lt;SearchResult.NavVo&gt; navs = result.getNavs();</span><br><span class="line">          SearchResult.<span class="type">NavVo</span> <span class="variable">navVo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchResult</span>.NavVo();</span><br><span class="line">          navVo.setNavName(<span class="string">&quot;品牌&quot;</span>);</span><br><span class="line">          <span class="comment">// 远程查询所有品牌</span></span><br><span class="line">          <span class="type">R</span> <span class="variable">r</span> <span class="operator">=</span> productFeignService.brandsInfo(param.getBrandIds());</span><br><span class="line">          <span class="keyword">if</span> (r.getCode() == <span class="number">0</span>) &#123;</span><br><span class="line">              List&lt;BrandVo&gt; brand = r.getData(<span class="string">&quot;brand&quot;</span>, <span class="keyword">new</span> <span class="title class_">TypeReference</span>&lt;List&lt;BrandVo&gt;&gt;() &#123;</span><br><span class="line">              &#125;);</span><br><span class="line">              <span class="type">StringBuffer</span> <span class="variable">stringBuffer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuffer</span>();</span><br><span class="line">              <span class="type">String</span> <span class="variable">replace</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">              <span class="keyword">for</span> (BrandVo brandVo : brand) &#123;</span><br><span class="line">                  stringBuffer.append(brandVo.getName()+<span class="string">&quot;;&quot;</span>);</span><br><span class="line">                  replace = replaceQueryString(param, <span class="string">&quot;&quot;</span> + brandVo.getBrandId(), <span class="string">&quot;brandIds&quot;</span>);</span><br><span class="line">              &#125;</span><br><span class="line">              navVo.setNavValue(stringBuffer.toString());</span><br><span class="line">              navVo.setLink(<span class="string">&quot;http://search.gulimall.com:8081/list.html?&quot;</span> + replace);</span><br><span class="line"></span><br><span class="line">          &#125;</span><br><span class="line">          navs.add(navVo);</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure>

<h3 id="P193-异步"><a href="#P193-异步" class="headerlink" title="P193 异步"></a>P193 异步</h3><ol>
<li>初始化线程的4种方式<ol>
<li>继承Thread</li>
<li>实现Runable接口</li>
<li>实现Callable接口+FutureTask (可以拿到放回结果、可以处理异常)</li>
<li>线程池</li>
</ol>
</li>
<li>区别<ul>
<li>1、2不能得到返回值，3可以拿到返回值</li>
<li>1、2、3都不能控制资源</li>
<li>4可以控制资源，性能稳定</li>
</ul>
</li>
<li>样例</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ThreadTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">ExecutorService</span> <span class="variable">service</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">10</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ExecutionException, InterruptedException &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;main...start......&quot;</span>);</span><br><span class="line">        <span class="comment">// 1. 继承Thread</span></span><br><span class="line"><span class="comment">//        Thread01 thread01 = new Thread01();</span></span><br><span class="line"><span class="comment">//        thread01.start();</span></span><br><span class="line">        <span class="comment">// 2. 实现Runable接口</span></span><br><span class="line"><span class="comment">//        new Thread(new Thread02()).start();</span></span><br><span class="line">        <span class="comment">// 3. 实现Callable接口，FutureTask返回结果</span></span><br><span class="line"><span class="comment">//        FutureTask&lt;Integer&gt; futureTask = new FutureTask&lt;&gt;(new Thread03());</span></span><br><span class="line"><span class="comment">//        new Thread(futureTask).start();</span></span><br><span class="line">        <span class="comment">// 需要等整个线程执行完，才获取返回结果；阻塞等待！</span></span><br><span class="line"><span class="comment">//        Integer res = futureTask.get();</span></span><br><span class="line"><span class="comment">//        System.out.println(&quot;执行结果：&quot; + res);</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4. 使用线程池</span></span><br><span class="line">        service.execute(<span class="keyword">new</span> <span class="title class_">Thread01</span>());</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;main...end......&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 1. 继承thread</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Thread01</span> <span class="keyword">extends</span> <span class="title class_">Thread</span> &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;当前线程：&quot;</span> + Thread.currentThread().getId());</span><br><span class="line">            System.out.println(<span class="string">&quot;运行结果：&quot;</span> + <span class="number">10</span> % <span class="number">7</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 2. 实现Runable接口</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span>  <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Thread02</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;当前线程：&quot;</span> + Thread.currentThread().getId());</span><br><span class="line">            System.out.println(<span class="string">&quot;运行结果：&quot;</span> + <span class="number">11</span> % <span class="number">7</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 实现Callable接口</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Thread03</span> <span class="keyword">implements</span> <span class="title class_">Callable</span>&lt;Integer&gt; &#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> Integer <span class="title function_">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;当前线程：&quot;</span> + Thread.currentThread().getId());</span><br><span class="line">            <span class="type">int</span> <span class="variable">res</span> <span class="operator">=</span> <span class="number">12</span> % <span class="number">7</span>;</span><br><span class="line">            System.out.println(<span class="string">&quot;运行结果：&quot;</span> + res);</span><br><span class="line">            <span class="keyword">return</span> res;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="P194-线程池详解"><a href="#P194-线程池详解" class="headerlink" title="P194 线程池详解"></a>P194 线程池详解</h3><p>线程池7大参数：</p>
<ul>
<li>corePoolSize - 保留在池中的线程数，即使它们是空闲的，除非设置了 allowCoreThreadTimeOut</li>
<li>maximumPoolSize – 池中允许的最大线程数</li>
<li>keepAliveTime – 当线程数大于核心时，这是多余的空闲线程在终止前等待新任务的最长时间。<br>unit – keepAliveTime 参数的时间单位</li>
<li>workQueue – 用于在执行任务之前保存任务的队列。 此队列将仅保存由 execute 方法提交的 Runnable 任务</li>
<li>threadFactory – 执行器创建新线程时使用的工厂</li>
<li>handler – 由于达到线程边界和队列容量而阻塞执行时使用的处理程序</li>
</ul>
<p>工作顺序：</p>
<ol>
<li>线程池创建，准备好core数量的核心线程，准备接收任务<ol>
<li>core满了，就将再进来的任务放进阻塞队列中，空闲的core就会自己去阻塞队列获取任务执行</li>
<li>阻塞队列满了，就直接开新线程执行，最大只能开到max指定的数量</li>
<li>max满了就使用RejectedExecutionHandler拒绝任务</li>
<li>max都执行完成，有很多空闲，在指定的时间keepAliveTime以后，释放max-core这些线程</li>
</ol>
</li>
</ol>
<h5 id="面试题"><a href="#面试题" class="headerlink" title="面试题"></a>面试题</h5><p>一个线程池，core&#x3D;7，max&#x3D;20，queue&#x3D;50，100并发请求过来怎么分配的。</p>
<p>A：7个会立即执行，50个进队列，再开13个进行执行，剩下30使用拒绝策略。</p>
<p>常见的4种线程池</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 常见的四种线程池</span></span><br><span class="line">Executors.newCachedThreadPool();  <span class="comment">// core=0，所有线程都可回收</span></span><br><span class="line">Executors.newFixedThreadPool(<span class="number">10</span>);  <span class="comment">// 固定大小，core=max，都不可回收</span></span><br><span class="line">Executors.newScheduledThreadPool();  <span class="comment">// 定时任务</span></span><br><span class="line">Executors.newSingleThreadExecutor();  <span class="comment">// 单线程的线程池，后台从队列里面获取任务，挨个执行</span></span><br></pre></td></tr></table></figure>

<p>4 、 开发中为什么使用线程池</p>
<ul>
<li><p>降低资源的消耗</p>
<ul>
<li>通过重复利用已经创建好的线程降低线程的创建和销毁带来的损耗</li>
</ul>
</li>
<li><p>提高响应速度</p>
</li>
<li><p>因为线程池中的线程数没有超过线程池的最大上限时， 有的线程处于等待分配任务<br>的状态，当任务来时无需创建新的线程就能执行</p>
</li>
<li><p>提高线程的可管理性</p>
<ul>
<li>线程池会根据当前系统特点对池内的线程进行优化处理， 减少创建和销毁线程带来<br>的系统开销。无限的创建和销毁线程不仅消耗系统资源，还降低系统的稳定性，使<br>用线程池进行统一分配</li>
</ul>
</li>
</ul>
<h3 id="P195-196-CompletableFuture"><a href="#P195-196-CompletableFuture" class="headerlink" title="P195-196 CompletableFuture"></a>P195-196 CompletableFuture</h3><p>异步编排</p>
<ul>
<li>CompletableFuture.runAsync()</li>
<li>CompletableFuture.supplyAsync() 有返回值</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//        CompletableFuture&lt;void&gt; future = CompletableFuture.runAsync(() -&gt; &#123;</span></span><br><span class="line"><span class="comment">//            System.out.println(&quot;当前线程：&quot; + Thread.currentThread().getId());</span></span><br><span class="line"><span class="comment">//            int res = 13 % 7;</span></span><br><span class="line"><span class="comment">//            System.out.println(&quot;运行结果：&quot; + res);</span></span><br><span class="line"><span class="comment">////            return res;</span></span><br><span class="line"><span class="comment">//        &#125;, service);</span></span><br><span class="line">        CompletableFuture&lt;Integer&gt; future = CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;当前线程：&quot;</span> + Thread.currentThread().getId());</span><br><span class="line">            <span class="type">int</span> <span class="variable">res</span> <span class="operator">=</span> <span class="number">13</span> % <span class="number">7</span>;</span><br><span class="line">            System.out.println(<span class="string">&quot;运行结果：&quot;</span> + res);</span><br><span class="line">            <span class="keyword">return</span> res;</span><br><span class="line">        &#125;, service);</span><br><span class="line">        <span class="type">Integer</span> <span class="variable">res</span> <span class="operator">=</span> future.get();</span><br><span class="line">        System.out.println(<span class="string">&quot;Result: &quot;</span> + res);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;main...end......&quot;</span>);</span><br></pre></td></tr></table></figure>

<h3 id="P197-198-完成回调与感知异常"><a href="#P197-198-完成回调与感知异常" class="headerlink" title="P197-198 完成回调与感知异常"></a>P197-198 完成回调与感知异常</h3><ul>
<li>whenCompleteAsync()</li>
<li>exceptionally()</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">CompletableFuture&lt;Integer&gt; future = CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;当前线程：&quot;</span> + Thread.currentThread().getId());</span><br><span class="line">            <span class="type">int</span> <span class="variable">res</span> <span class="operator">=</span> <span class="number">13</span> % <span class="number">0</span>;</span><br><span class="line">            System.out.println(<span class="string">&quot;运行结果：&quot;</span> + res);</span><br><span class="line">            <span class="keyword">return</span> res;</span><br><span class="line">        &#125;, service).whenCompleteAsync((res, exception) -&gt; &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;执行完成，Result：&quot;</span> + res + <span class="string">&quot;; 异常是：&quot;</span> + exception);</span><br><span class="line">        &#125;).exceptionally((throwable) -&gt; &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">10</span>;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="type">Integer</span> <span class="variable">res</span> <span class="operator">=</span> future.get();</span><br><span class="line">        System.out.println(<span class="string">&quot;Result: &quot;</span> + res)</span><br></pre></td></tr></table></figure>

<ul>
<li>handle</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 方法执行完成后的处理</span></span><br><span class="line">        CompletableFuture&lt;Integer&gt; future = CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;当前线程：&quot;</span> + Thread.currentThread().getId());</span><br><span class="line">            <span class="type">int</span> <span class="variable">res</span> <span class="operator">=</span> <span class="number">13</span> % <span class="number">1</span>;</span><br><span class="line">            System.out.println(<span class="string">&quot;运行结果：&quot;</span> + res);</span><br><span class="line">            <span class="keyword">return</span> res;</span><br><span class="line">        &#125;, service).handle((res, e) -&gt; &#123;</span><br><span class="line">            <span class="keyword">if</span> (res != <span class="literal">null</span>) &#123;</span><br><span class="line">                res = <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (e != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> res;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="type">Integer</span> <span class="variable">res</span> <span class="operator">=</span> future.get();</span><br><span class="line">        System.out.println(<span class="string">&quot;Result: &quot;</span> + res);</span><br></pre></td></tr></table></figure>

<h3 id="P199-线程串行化"><a href="#P199-线程串行化" class="headerlink" title="P199 线程串行化"></a>P199 线程串行化</h3><ul>
<li>.thenRunAsync() 不能获取上一步的执行结果，无返回值</li>
<li>.thenAcceptAsync() 能接受上一步结果，但是无返回值</li>
<li>.thenApplyAsync() 能接收上一步结果，有返回值</li>
</ul>
<h3 id="P200-两任务组合都要完成"><a href="#P200-两任务组合都要完成" class="headerlink" title="P200 两任务组合都要完成"></a>P200 两任务组合都要完成</h3><ul>
<li>future1.runAfterBothAsync()  <ul>
<li>组合两个 future，不需要获取 future 的结果，只需两个 future 处理完任务后，处理该任务</li>
</ul>
</li>
<li>future1.thenCombineAsync()  <ul>
<li>组合两个 future，获取两个 future 的返回结果，并返回当前任务的返回值</li>
</ul>
</li>
<li>thenAcceptBoth() <ul>
<li>组合两个 future，获取两个 future 任务的返回结果，然后处理任务，没有<br>返回值</li>
</ul>
</li>
</ul>
<h3 id="P201-两个任务组合–一个完成"><a href="#P201-两个任务组合–一个完成" class="headerlink" title="P201 两个任务组合–一个完成"></a>P201 两个任务组合–一个完成</h3><ul>
<li>future1.runAfterEitherAsync() <ul>
<li>两个任务有一个执行完成，不需要获取 future 的结果，处理任务，也没有返回值</li>
</ul>
</li>
<li>acceptEither()<ul>
<li>两个任务有一个执行完成，获取它的返回值，处理任务，没有新的返回值</li>
</ul>
</li>
<li>applyToEither()<ul>
<li>两个任务有一个执行完成，获取它的返回值，处理任务并有新的返回值</li>
</ul>
</li>
</ul>
<h3 id="P202-多任务组合"><a href="#P202-多任务组合" class="headerlink" title="P202 多任务组合"></a>P202 多任务组合</h3><ul>
<li>allOf：等待所有任务完成</li>
<li>anyOf: 只要有一个任务完成</li>
</ul>
<h3 id="P203-商品详情–环境搭建"><a href="#P203-商品详情–环境搭建" class="headerlink" title="P203 商品详情–环境搭建"></a>P203 商品详情–环境搭建</h3><ol>
<li>改hosts：item.gulimall.com</li>
<li>改nginx配置</li>
<li>改网关配置</li>
<li>加入前端文件</li>
<li>item.html请求controller</li>
</ol>
<h3 id="P204-商品详情–模型抽取"><a href="#P204-商品详情–模型抽取" class="headerlink" title="P204 商品详情–模型抽取"></a>P204 商品详情–模型抽取</h3><p>…</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Levy</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://levyya.github.io/2022/07/01/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E--%E9%AB%98%E7%BA%A7%E7%AF%87/">https://levyya.github.io/2022/07/01/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E--%E9%AB%98%E7%BA%A7%E7%AF%87/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://levyya.github.io" target="_blank">Levy's blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E9%A1%B9%E7%9B%AE/">项目</a></div><div class="post_share"><div class="social-share" data-image="https://levy-blog.oss-cn-hangzhou.aliyuncs.com/pics/TomAndJerry.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2022/07/12/LeetCode/"><img class="prev-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://levy-blog.oss-cn-hangzhou.aliyuncs.com/pics/TomAndJerry.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">LeetCode</div></div></a></div><div class="next-post pull-right"><a href="/2022/06/01/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E--%E5%9F%BA%E7%A1%80%E7%AF%87/"><img class="next-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://levy-blog.oss-cn-hangzhou.aliyuncs.com/pics/TomAndJerry.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">谷粒商城--基础篇</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2022/06/01/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E--%E5%9F%BA%E7%A1%80%E7%AF%87/" title="谷粒商城--基础篇"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://levy-blog.oss-cn-hangzhou.aliyuncs.com/pics/TomAndJerry.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-06-01</div><div class="title">谷粒商城--基础篇</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://levy-blog.oss-cn-hangzhou.aliyuncs.com/pics/%E9%98%BF%E5%B0%BC%E4%BA%9A.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Levy</div><div class="author-info__description"></div></div><div class="card-info-data is-center"><div class="card-info-data-item"><a href="/archives/"><div class="headline">文章</div><div class="length-num">70</div></a></div><div class="card-info-data-item"><a href="/tags/"><div class="headline">标签</div><div class="length-num">38</div></a></div><div class="card-info-data-item"><a href="/categories/"><div class="headline">分类</div><div class="length-num">18</div></a></div></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/Levyya"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">2025 努力生活！</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AD%A6%E4%B9%A0%E7%9B%AE%E6%A0%87"><span class="toc-number">1.</span> <span class="toc-text">学习目标</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E6%9C%8D%E5%8A%A1"><span class="toc-number">1.1.</span> <span class="toc-text">启动服务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%8B%E5%8A%9B%E6%B5%8B%E8%AF%95"><span class="toc-number">1.2.</span> <span class="toc-text">压力测试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#P103-Elasticsearch"><span class="toc-number">1.3.</span> <span class="toc-text">P103 Elasticsearch</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#ES%E5%AE%89%E8%A3%85"><span class="toc-number">1.3.0.1.</span> <span class="toc-text">ES安装</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9D%E6%AD%A5%E6%A3%80%E7%B4%A2"><span class="toc-number">1.3.1.</span> <span class="toc-text">初步检索</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%B4%A2%E5%BC%95%E6%96%87%E6%A1%A3"><span class="toc-number">1.3.1.1.</span> <span class="toc-text">索引文档</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E6%96%87%E6%A1%A3"><span class="toc-number">1.3.1.2.</span> <span class="toc-text">查看文档</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%9B%B4%E6%96%B0%E6%96%87%E6%A1%A3"><span class="toc-number">1.3.1.3.</span> <span class="toc-text">更新文档</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%A0%E9%99%A4%E6%96%87%E6%A1%A3%E6%88%96%E7%B4%A2%E5%BC%95"><span class="toc-number">1.3.1.4.</span> <span class="toc-text">删除文档或索引</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%89%B9%E9%87%8F%E6%93%8D%E4%BD%9C%E2%80%93bulk"><span class="toc-number">1.3.1.5.</span> <span class="toc-text">批量操作–bulk</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Search-API"><span class="toc-number">1.3.1.6.</span> <span class="toc-text">Search API</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Query-DSL"><span class="toc-number">1.3.1.7.</span> <span class="toc-text">Query DSL</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#P119-129"><span class="toc-number">1.4.</span> <span class="toc-text">P119-129</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Mapping"><span class="toc-number">1.4.0.1.</span> <span class="toc-text">Mapping</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%86%E8%AF%8D"><span class="toc-number">1.4.0.2.</span> <span class="toc-text">分词</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#P123-linux-%E7%BD%91%E7%BB%9C%E9%85%8D%E7%BD%AE-amp-yum-%E4%BF%AE%E6%94%B9%E6%BA%90"><span class="toc-number">1.5.</span> <span class="toc-text">P123 linux 网络配置 &amp; yum 修改源</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#P124-%E5%AE%89%E8%A3%85nginx-amp-%E8%87%AA%E5%AE%9A%E4%B9%89%E8%AF%8D%E5%BA%93"><span class="toc-number">1.6.</span> <span class="toc-text">P124 安装nginx &amp; 自定义词库</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#P125-SpringBoot-%E6%95%B4%E5%90%88ES"><span class="toc-number">1.7.</span> <span class="toc-text">P125 SpringBoot 整合ES</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%B8%A4%E4%B8%AAbug"><span class="toc-number">1.7.0.1.</span> <span class="toc-text">两个bug</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#P126-ES%E6%B5%8B%E8%AF%95%E4%BF%9D%E5%AD%98"><span class="toc-number">1.8.</span> <span class="toc-text">P126 ES测试保存</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#P127-ES%E6%B5%8B%E8%AF%95%E5%A4%8D%E6%9D%82%E6%A3%80%E7%B4%A2"><span class="toc-number">1.9.</span> <span class="toc-text">P127 ES测试复杂检索</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#P128-%E4%B8%8A%E6%9E%B6%E6%A8%A1%E5%9E%8B%E5%88%86%E6%9E%90"><span class="toc-number">1.10.</span> <span class="toc-text">P128 上架模型分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#P129-nested%E5%88%86%E6%9E%90"><span class="toc-number">1.11.</span> <span class="toc-text">P129 nested分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#P130-%E5%95%86%E5%93%81%E4%B8%8A%E6%9E%B6"><span class="toc-number">1.12.</span> <span class="toc-text">P130 商品上架</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#ES%E4%BF%9D%E5%AD%98%E7%B4%A2%E5%BC%95"><span class="toc-number">1.12.1.</span> <span class="toc-text">ES保存索引</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link"><span class="toc-number">1.13.</span> <span class="toc-text"></span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#P134-Feign-%E5%8E%9F%E7%90%86"><span class="toc-number">1.14.</span> <span class="toc-text">P134  Feign 原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#P135-%E6%8A%BD%E5%8F%96%E5%93%8D%E5%BA%94%E7%BB%93%E6%9E%9C"><span class="toc-number">1.15.</span> <span class="toc-text">P135 抽取响应结果</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#P136-%E9%A6%96%E9%A1%B5%E2%80%93%E6%95%B4%E5%90%88Thymeleaf"><span class="toc-number">1.16.</span> <span class="toc-text">P136 首页–整合Thymeleaf</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#P137-Thymeleaf%E2%80%93%E5%89%8D%E7%AB%AF%E5%88%86%E7%B1%BB"><span class="toc-number">1.17.</span> <span class="toc-text">P137 Thymeleaf–前端分类</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%83%AD%E9%83%A8%E7%BD%B2"><span class="toc-number">1.17.0.1.</span> <span class="toc-text">热部署</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#P138-%E6%B8%B2%E6%9F%93%E4%BA%8C%E4%B8%89%E7%BA%A7%E5%88%86%E7%B1%BB"><span class="toc-number">1.18.</span> <span class="toc-text">P138 渲染二三级分类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#P139-nginx-%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86"><span class="toc-number">1.19.</span> <span class="toc-text">P139 nginx 反向代理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#P140-nginx-%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E5%88%B0%E7%BD%91%E5%85%B3"><span class="toc-number">1.20.</span> <span class="toc-text">P140 nginx 负载均衡到网关</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#P141-%E5%8E%8B%E5%8A%9B%E6%B5%8B%E8%AF%95"><span class="toc-number">1.21.</span> <span class="toc-text">P141 压力测试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#P143-JMeter-%E5%BC%82%E5%B8%B8%E8%A7%A3%E5%86%B3"><span class="toc-number">1.22.</span> <span class="toc-text">P143 JMeter 异常解决</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#P144-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E6%80%9D%E8%B7%AF"><span class="toc-number">1.23.</span> <span class="toc-text">P144 性能优化思路</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#P145-jvm-%E7%9B%91%E6%8E%A7"><span class="toc-number">1.24.</span> <span class="toc-text">P145 jvm 监控</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#P146-%E5%8E%8B%E5%8A%9B%E6%B5%8B%E8%AF%95%E2%80%93%E4%B8%AD%E9%97%B4%E4%BB%B6%E3%80%81%E5%85%A8%E9%93%BE%E8%B7%AF"><span class="toc-number">1.25.</span> <span class="toc-text">P146 压力测试–中间件、全链路</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BC%98%E5%8C%96%E6%96%B9%E5%90%91"><span class="toc-number">1.25.1.</span> <span class="toc-text">优化方向</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%8B%E6%B5%8B%E7%BB%93%E6%9E%9C"><span class="toc-number">1.26.</span> <span class="toc-text">@压测结果</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#P147-%E7%AE%80%E5%8D%95%E4%BC%98%E5%8C%96"><span class="toc-number">1.27.</span> <span class="toc-text">P147 简单优化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#P148-nginx-%E5%8A%A8%E9%9D%99%E5%88%86%E7%A6%BB"><span class="toc-number">1.28.</span> <span class="toc-text">P148 nginx 动静分离</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#P149-%E6%A8%A1%E6%8B%9F%E5%AE%95%E6%9C%BA"><span class="toc-number">1.29.</span> <span class="toc-text">P149 模拟宕机</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#P150-%E4%BC%98%E5%8C%96%E4%B8%89%E7%BA%A7%E5%88%86%E7%B1%BB%E6%9F%A5%E8%AF%A2"><span class="toc-number">1.30.</span> <span class="toc-text">P150 优化三级分类查询</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#P151-%E7%BC%93%E5%AD%98%E4%B8%8E%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81"><span class="toc-number">1.31.</span> <span class="toc-text">P151 缓存与分布式锁</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#P152-%E6%95%B4%E5%90%88redis"><span class="toc-number">1.32.</span> <span class="toc-text">P152 整合redis</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#P153-redis%E7%BC%93%E5%AD%98%E4%B8%89%E7%BA%A7%E5%88%86%E7%B1%BB"><span class="toc-number">1.33.</span> <span class="toc-text">P153 redis缓存三级分类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#P157-%E6%9C%AC%E5%9C%B0%E9%94%81%E9%97%AE%E9%A2%98"><span class="toc-number">1.34.</span> <span class="toc-text">P157 本地锁问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#P158-redis-%E5%AE%9E%E7%8E%B0%E5%88%86%E5%B8%83%E9%94%81"><span class="toc-number">1.35.</span> <span class="toc-text">P158 redis 实现分布锁</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#P159-redisson"><span class="toc-number">1.36.</span> <span class="toc-text">P159 redisson</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#P160-lock%E9%94%81%E6%B5%8B%E8%AF%95"><span class="toc-number">1.37.</span> <span class="toc-text">P160 lock锁测试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#P161-lock%E7%9C%8B%E9%97%A8%E7%8B%97%E5%8E%9F%E7%90%86"><span class="toc-number">1.38.</span> <span class="toc-text">P161 lock看门狗原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#P162-%E8%AF%BB%E5%86%99%E9%94%81"><span class="toc-number">1.39.</span> <span class="toc-text">P162 读写锁</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#P163-%E8%AF%BB%E5%86%99%E9%94%81%E8%A1%A5%E5%85%85"><span class="toc-number">1.40.</span> <span class="toc-text">P163 读写锁补充</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#P164-%E9%97%AD%E9%94%81"><span class="toc-number">1.41.</span> <span class="toc-text">P164 闭锁</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#P165-%E4%BF%A1%E5%8F%B7%E9%87%8F"><span class="toc-number">1.42.</span> <span class="toc-text">P165 信号量</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#P166-%E7%BC%93%E5%AD%98%E4%B8%80%E8%87%B4%E6%80%A7%E9%97%AE%E9%A2%98"><span class="toc-number">1.43.</span> <span class="toc-text">P166 缓存一致性问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#P167-168-SpringCache"><span class="toc-number">1.44.</span> <span class="toc-text">P167-168 SpringCache</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#P169-cacheable-%E7%BB%86%E8%8A%82%E8%AE%BE%E7%BD%AE"><span class="toc-number">1.45.</span> <span class="toc-text">P169 @cacheable 细节设置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#P170-%E8%87%AA%E5%AE%9A%E4%B9%89%E7%BC%93%E5%AD%98%E9%85%8D%E7%BD%AE"><span class="toc-number">1.46.</span> <span class="toc-text">P170 自定义缓存配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#P171-CacheEvict"><span class="toc-number">1.47.</span> <span class="toc-text">P171  @CacheEvict</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#P172-SpringCache%E7%9A%84%E4%B8%8D%E8%B6%B3"><span class="toc-number">1.48.</span> <span class="toc-text">P172 SpringCache的不足</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#P173-%E6%A3%80%E7%B4%A2%E6%9C%8D%E5%8A%A1"><span class="toc-number">1.49.</span> <span class="toc-text">P173 检索服务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#P174-%E8%B0%83%E6%95%B4%E9%A1%B5%E9%9D%A2%E8%B7%B3%E8%BD%AC"><span class="toc-number">1.50.</span> <span class="toc-text">P174 调整页面跳转</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#P175-%E6%A3%80%E7%B4%A2%E6%9F%A5%E8%AF%A2%E5%8F%82%E6%95%B0%E6%A8%A1%E5%9E%8B%E5%88%86%E6%9E%90"><span class="toc-number">1.51.</span> <span class="toc-text">P175 检索查询参数模型分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#P176-%E6%A3%80%E7%B4%A2%E8%BF%94%E5%9B%9E%E7%BB%93%E6%9E%9C%E6%A8%A1%E5%9E%8B%E5%88%86%E6%9E%90"><span class="toc-number">1.52.</span> <span class="toc-text">P176 检索返回结果模型分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#P177-%E6%A3%80%E7%B4%A2DSL%E2%80%93%E6%9F%A5%E8%AF%A2"><span class="toc-number">1.53.</span> <span class="toc-text">P177 检索DSL–查询</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#P178-%E6%A3%80%E7%B4%A2DSL%E2%80%93%E8%81%9A%E5%90%88"><span class="toc-number">1.54.</span> <span class="toc-text">P178 检索DSL–聚合</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#P179-SearchRequest%E2%80%93%E6%A3%80%E7%B4%A2"><span class="toc-number">1.55.</span> <span class="toc-text">P179 SearchRequest–检索</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#P180-%E6%B5%8B%E8%AF%95%E6%9F%A5%E8%AF%A2DSL"><span class="toc-number">1.56.</span> <span class="toc-text">P180 测试查询DSL</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#P181-%E6%B5%8B%E8%AF%95%E8%81%9A%E5%90%88DSL"><span class="toc-number">1.57.</span> <span class="toc-text">P181 测试聚合DSL</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#P182-183-%E8%B0%83%E8%AF%95-amp-%E9%AB%98%E4%BA%AE"><span class="toc-number">1.58.</span> <span class="toc-text">P182-183 调试&amp;高亮</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#P184-%E9%A1%B5%E9%9D%A2%E5%9F%BA%E6%9C%AC%E6%95%B0%E6%8D%AE%E6%B8%B2%E6%9F%93"><span class="toc-number">1.59.</span> <span class="toc-text">P184 页面基本数据渲染</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#P185-%E9%A1%B5%E9%9D%A2%E7%AD%9B%E9%80%89%E6%9D%A1%E4%BB%B6%E6%B8%B2%E6%9F%93"><span class="toc-number">1.60.</span> <span class="toc-text">P185 页面筛选条件渲染</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#P186-%E9%A1%B5%E9%9D%A2%E5%88%86%E9%A1%B5%E6%95%B0%E6%8D%AE%E6%B8%B2%E6%9F%93"><span class="toc-number">1.61.</span> <span class="toc-text">P186 页面分页数据渲染</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#P187-%E9%A1%B5%E9%9D%A2%E6%8E%92%E5%BA%8F"><span class="toc-number">1.62.</span> <span class="toc-text">P187 页面排序</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#P188-%E9%A1%B5%E9%9D%A2%E6%8E%92%E5%BA%8F%E5%AD%97%E6%AE%B5%E5%9B%9E%E6%98%BE"><span class="toc-number">1.63.</span> <span class="toc-text">P188 页面排序字段回显</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#P189-%E9%A1%B5%E9%9D%A2%E4%BB%B7%E6%A0%BC%E5%8C%BA%E9%97%B4"><span class="toc-number">1.64.</span> <span class="toc-text">P189 页面价格区间</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#P190-%E9%9D%A2%E5%8C%85%E5%B1%91%E5%AF%BC%E8%88%AA"><span class="toc-number">1.65.</span> <span class="toc-text">P190 面包屑导航</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#P191-%E6%9D%A1%E4%BB%B6%E5%88%A0%E9%99%A4%E4%B8%8EURL%E7%BC%96%E7%A0%81%E9%97%AE%E9%A2%98"><span class="toc-number">1.66.</span> <span class="toc-text">P191 条件删除与URL编码问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#P192-%E6%9D%A1%E4%BB%B6%E7%AD%9B%E9%80%89%E8%81%94%E5%8A%A8"><span class="toc-number">1.67.</span> <span class="toc-text">P192 条件筛选联动</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#P193-%E5%BC%82%E6%AD%A5"><span class="toc-number">1.68.</span> <span class="toc-text">P193 异步</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#P194-%E7%BA%BF%E7%A8%8B%E6%B1%A0%E8%AF%A6%E8%A7%A3"><span class="toc-number">1.69.</span> <span class="toc-text">P194 线程池详解</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%9D%A2%E8%AF%95%E9%A2%98"><span class="toc-number">1.69.0.1.</span> <span class="toc-text">面试题</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#P195-196-CompletableFuture"><span class="toc-number">1.70.</span> <span class="toc-text">P195-196 CompletableFuture</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#P197-198-%E5%AE%8C%E6%88%90%E5%9B%9E%E8%B0%83%E4%B8%8E%E6%84%9F%E7%9F%A5%E5%BC%82%E5%B8%B8"><span class="toc-number">1.71.</span> <span class="toc-text">P197-198 完成回调与感知异常</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#P199-%E7%BA%BF%E7%A8%8B%E4%B8%B2%E8%A1%8C%E5%8C%96"><span class="toc-number">1.72.</span> <span class="toc-text">P199 线程串行化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#P200-%E4%B8%A4%E4%BB%BB%E5%8A%A1%E7%BB%84%E5%90%88%E9%83%BD%E8%A6%81%E5%AE%8C%E6%88%90"><span class="toc-number">1.73.</span> <span class="toc-text">P200 两任务组合都要完成</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#P201-%E4%B8%A4%E4%B8%AA%E4%BB%BB%E5%8A%A1%E7%BB%84%E5%90%88%E2%80%93%E4%B8%80%E4%B8%AA%E5%AE%8C%E6%88%90"><span class="toc-number">1.74.</span> <span class="toc-text">P201 两个任务组合–一个完成</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#P202-%E5%A4%9A%E4%BB%BB%E5%8A%A1%E7%BB%84%E5%90%88"><span class="toc-number">1.75.</span> <span class="toc-text">P202 多任务组合</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#P203-%E5%95%86%E5%93%81%E8%AF%A6%E6%83%85%E2%80%93%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="toc-number">1.76.</span> <span class="toc-text">P203 商品详情–环境搭建</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#P204-%E5%95%86%E5%93%81%E8%AF%A6%E6%83%85%E2%80%93%E6%A8%A1%E5%9E%8B%E6%8A%BD%E5%8F%96"><span class="toc-number">1.77.</span> <span class="toc-text">P204 商品详情–模型抽取</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2023/11/12/hexo%20%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/" title="Hexo 常用命令"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://levy-blog.oss-cn-hangzhou.aliyuncs.com/pics/TomAndJerry.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Hexo 常用命令"/></a><div class="content"><a class="title" href="/2023/11/12/hexo%20%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/" title="Hexo 常用命令">Hexo 常用命令</a><time datetime="2023-11-12T02:18:11.608Z" title="发表于 2023-11-12 10:18:11">2023-11-12</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/06/05/%E4%BB%A3%E7%A0%81%E6%95%B4%E6%B4%81%E4%B9%8B%E9%81%93/" title="代码整洁之道"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://levy-blog.oss-cn-hangzhou.aliyuncs.com/pics/TomAndJerry.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="代码整洁之道"/></a><div class="content"><a class="title" href="/2023/06/05/%E4%BB%A3%E7%A0%81%E6%95%B4%E6%B4%81%E4%B9%8B%E9%81%93/" title="代码整洁之道">代码整洁之道</a><time datetime="2023-06-05T07:33:02.000Z" title="发表于 2023-06-05 15:33:02">2023-06-05</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/05/22/LLaMA%E6%A8%A1%E5%9E%8B%E7%9B%B8%E5%85%B3/" title="LLaMA模型相关"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://levy-blog.oss-cn-hangzhou.aliyuncs.com/pics/TomAndJerry.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="LLaMA模型相关"/></a><div class="content"><a class="title" href="/2023/05/22/LLaMA%E6%A8%A1%E5%9E%8B%E7%9B%B8%E5%85%B3/" title="LLaMA模型相关">LLaMA模型相关</a><time datetime="2023-05-22T08:35:00.000Z" title="发表于 2023-05-22 16:35:00">2023-05-22</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/04/02/%E8%BD%AF%E8%80%83-%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84%E5%B8%88/" title="软考--系统架构师"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://levy-blog.oss-cn-hangzhou.aliyuncs.com/pics/TomAndJerry.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="软考--系统架构师"/></a><div class="content"><a class="title" href="/2023/04/02/%E8%BD%AF%E8%80%83-%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84%E5%B8%88/" title="软考--系统架构师">软考--系统架构师</a><time datetime="2023-04-02T06:21:03.000Z" title="发表于 2023-04-02 14:21:03">2023-04-02</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/03/20/%E8%93%9D%E6%A1%A5%E6%9D%AF/" title="蓝桥杯"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://levy-blog.oss-cn-hangzhou.aliyuncs.com/pics/TomAndJerry.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="蓝桥杯"/></a><div class="content"><a class="title" href="/2023/03/20/%E8%93%9D%E6%A1%A5%E6%9D%AF/" title="蓝桥杯">蓝桥杯</a><time datetime="2023-03-20T03:06:09.000Z" title="发表于 2023-03-20 11:06:09">2023-03-20</time></div></div></div></div></div></div></main><footer id="footer" style="background: #ace0f9"><div id="footer-wrap"><div class="copyright">&copy;2022 - 2025 By Levy</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><div class="js-pjax"><script>if (!window.MathJax) {
  window.MathJax = {
    tex: {
      inlineMath: [ ['$','$'], ["\\(","\\)"]],
      tags: 'ams'
    },
    chtml: {
      scale: 1.2
    },
    options: {
      renderActions: {
        findScript: [10, doc => {
          for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
            const display = !!node.type.match(/; *mode=display/)
            const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
            const text = document.createTextNode('')
            node.parentNode.replaceChild(text, node)
            math.start = {node: text, delim: '', n: 0}
            math.end = {node: text, delim: '', n: 0}
            doc.math.push(math)
          }
        }, ''],
        insertScript: [200, () => {
          document.querySelectorAll('mjx-container:not\([display]\)').forEach(node => {
            const target = node.parentNode
            if (target.nodeName.toLowerCase() === 'li') {
              target.parentNode.classList.add('has-jax')
            } else {
              target.classList.add('has-jax')
            }
          });
        }, '', false]
      }
    }
  }
  
  const script = document.createElement('script')
  script.src = 'https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js'
  script.id = 'MathJax-script'
  script.async = true
  document.head.appendChild(script)
} else {
  MathJax.startup.document.state(0)
  MathJax.texReset()
  MathJax.typeset()
}</script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/katex@latest/dist/katex.min.css"><script src="https://cdn.jsdelivr.net/npm/katex@latest/dist/contrib/copy-tex.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/katex@latest/dist/contrib/copy-tex.css"><script>(() => {
  document.querySelectorAll('#article-container span.katex-display').forEach(item => {
    btf.wrap(item, 'div', { class: 'katex-wrap'})
  })
})()</script></div><script id="click-show-text" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/click-show-text.min.js" data-mobile="false" data-text="开心,哈哈哈哈哈哈,Happy,快乐,无所畏惧,一往无前,Power,Passion" data-fontsize="20px" data-random="true" async="async"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>